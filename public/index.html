<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ç›†æ ½æˆæœ¬è®°å½•ç³»ç»Ÿ Lover Legend Gardening</title>
<style>
  body {
    font-family: sans-serif;
    background-color: #f5f5f5;
    margin: 0;
    padding: 20px;
  }
  .header {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    margin-bottom: 10px;
  }
  .header img { height: 50px; }
  .header h1 {
    font-size: 24px;
    margin: 0;
  }
  h2 {
    font-size: 18px;
    text-align: center;
    margin: 5px 0 15px;
    grid-column: 1 / -1;
  }
  form {
    background: #fff;
    padding: 20px;
    border-radius: 12px;
    max-width: 1000px;
    margin: auto;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px 20px;
  }
  label {
    font-weight: bold;
    font-size: 14px;
  }
  input, select, textarea {
    width: 100%;
    padding: 6px 8px;
    font-size: 14px;
    box-sizing: border-box;
    white-space: pre-wrap;
    overflow: hidden;
  }
  input::placeholder { color:#999; }
  .currency-placeholder { color:#999; }
  input[type=number]::-webkit-inner-spin-button,
  input[type=number]::-webkit-outer-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }
  .full { grid-column: 1 / -1; }
  .highlight { color: red; font-weight: bold; }
  .error {
    border: 2px solid red !important;
    background-color: #ffe6e6 !important;
  }
  .url-link {
    color: blue;
    text-decoration: underline;
    cursor: pointer;
  }
  .row3 { display: flex; gap: 6px; }
  .row3 > * { flex: 1; }
  .entry {
    font-size: 16px;
    margin-top: 4px;
  }
  .top-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    grid-column: 1 / -1;
  }
  .top-bar button {
    font-size: 14px;
    padding: 4px 10px;
    cursor: pointer;
  }
  #autoSaveStatus {
    font-size:12px;
    color:#666;
    margin-left:8px;
  }
  .with-datalist::-webkit-calendar-picker-indicator {
    display: none !important;
  }
  .date-error {
    color: red;
    font-size: 12px;
    margin-top: -10px;
    margin-bottom: 5px;
    grid-column: 1 / -1;
    display: none;
  }
  .shipping-section {
    background-color: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    margin-top: 15px;
    border: 1px solid #dee2e6;
    grid-column: 1 / -1;
  }
  .shipping-field:disabled {
    background-color: #e9ecef;
    opacity: 1;
  }
  .required-field {
    border-left: 3px solid #dc3545;
    padding-left: 5px;
  }
  .status-badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: bold;
  }
  .status-purchasing {
    background-color: #6c757d;
    color: white;
  }
  .status-shipping {
    background-color: #ffc107;
    color: #212529;
  }
  .status-completed {
    background-color: #198754;
    color: white;
  }
  #prepareShipping {
    background-color: #0d6efd;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    grid-column: 1 / -1;
    margin-top: 10px;
  }
  #prepareShipping:hover {
    background-color: #0b5ed7;
  }
  /* æ–°å¢é”™è¯¯æç¤ºæ ·å¼ */
  .firebase-error {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px;
    background: #ff4444;
    color: white;
    border-radius: 5px;
    z-index: 10000;
    max-width: 300px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    animation: slideIn 0.3s ease-out;
  }
  @keyframes slideIn {
    from { transform: translateX(100%); }
    to { transform: translateX(0); }
  }
</style>
</head>
<body>
  <div class="header">
    <img src="logo.png" alt="logo">
    <h1>ç›†æ ½æˆæœ¬è®°å½•ç³»ç»Ÿ Lover Legend Gardening</h1>
  </div>

  <form id="bonsaiForm" autocomplete="off">
    <!-- çŠ¶æ€æ˜¾ç¤º -->
    <div class="top-bar">
      <div>
        <span id="form-status" class="status-badge status-purchasing">é‡‡è´­ä¸­</span>
        <span id="autoSaveStatus"></span>
      </div>
      <button type="button" onclick="manualSave()">ğŸ’¾ ä¿å­˜è®°å½•</button>
    </div>

    <!-- ğŸŒ± é‡‡è´­ä¿¡æ¯éƒ¨åˆ† -->
    <h2 class="full">ğŸŒ± é‡‡è´­ä¿¡æ¯</h2>

    <label for="supplier" class="required-field">ä¾›åº”å•†</label>
    <label for="variety" class="required-field">å“ç§</label>
    <input id="supplier" list="supplierHistory" class="with-datalist" required />
    <input id="variety" list="varietyHistory" class="with-datalist" required />
    <datalist id="supplierHistory"></datalist>
    <datalist id="varietyHistory"></datalist>

    <label>å¸å€¼ + å•ä»·ï¼ˆåŸå¸ï¼‰+ RM æœ¬é’±</label>
    <label for="quantity" class="required-field">æ•°é‡ï¼ˆæ£µï¼‰</label>
    <div class="row3">
      <select id="currency">
        <option value="CNY">CNY</option>
        <option value="VND">VND</option>
        <option value="NTD">NTD</option>
        <option value="IDR">IDR</option>
      </select>
      <input id="price" type="text" inputmode="decimal" placeholder="0.00" class="required-field" />
      <input id="price_rm" disabled placeholder="0.00" />
    </div>
    <input id="quantity" type="number" inputmode="numeric" pattern="[0-9]*" placeholder="0" required />

    <label for="image_url">å›¾ç‰‡ç½‘å€</label>
    <div class="full"></div>
    <input id="image_url" type="url" class="url-link" placeholder="https://..." onclick="openImageUrl(this)" />

    <!-- ğŸš› å‘è´§ä¿¡æ¯éƒ¨åˆ† -->
    <div class="shipping-section">
      <h2>ğŸš› å‘è´§ä¿¡æ¯</h2>

      <label for="shipment_id">å‘è´§å•å·</label>
      <label for="total_plants">å‘è´§æ€»æ•°</label>
      <input id="shipment_id" class="shipping-field" disabled placeholder="ä¾‹å¦‚ 2025CNY01" />
      <input id="total_plants" type="number" inputmode="numeric" pattern="[0-9]*" placeholder="0" class="shipping-field" disabled />

      <label for="total_amount">å‘è´§æ€»é‡‘é¢ï¼ˆRMè‡ªåŠ¨ï¼‰</label>
      <label for="packing">åŒ…è£…æ˜ç»†ï¼ˆæœ¨æ¶ï¼Œç®±å­ï¼‰</label>
      <input id="total_amount" disabled placeholder="0.00" class="shipping-field" />
      <input id="packing" placeholder="ä¾‹å¦‚ï¼š1æœ¨æ¶2ç®±å­" class="shipping-field" disabled />

      <label for="warehouse_date">æŠµè¾¾ä»“åº“æ—¥æœŸ</label>
      <label for="container_date">è£…æŸœæ—¥æœŸ</label>
      <input id="warehouse_date" class="shipping-field date-input" placeholder="DD/MM/YY" disabled />
      <div id="warehouse_date_error" class="date-error">è¯·è¾“å…¥æœ‰æ•ˆçš„æ—¥æœŸæ ¼å¼ (DD/MM/YY)</div>
      <input id="container_date" class="shipping-field date-input" placeholder="DD/MM/YY" disabled />
      <div id="container_date_error" class="date-error">è¯·è¾“å…¥æœ‰æ•ˆçš„æ—¥æœŸæ ¼å¼ (DD/MM/YY)</div>

      <label for="shipping_no">æµ·è¿å•å·</label>
      <label for="arrival_date">æŠµè¾¾æ—¥æœŸ</label>
      <input id="shipping_no" class="shipping-field" disabled />
      <input id="arrival_date" class="shipping-field date-input" placeholder="DD/MM/YY" disabled />
      <div id="arrival_date_error" class="date-error">è¯·è¾“å…¥æœ‰æ•ˆçš„æ—¥æœŸæ ¼å¼ (DD/MM/YY)</div>

      <label for="freight_fee">è¿è´¹ï¼ˆRMï¼‰</label>
      <label for="days">è¿è¾“å¤©æ•°</label>
      <input id="freight_fee" type="text" inputmode="decimal" placeholder="0.00" class="shipping-field" disabled />
      <input id="days" disabled placeholder="0" />

      <label for="freight_ratio">è¿è´¹æ¯”ä¾‹ï¼ˆè‡ªåŠ¨ï¼‰</label>
      <div class="full"></div>
      <input id="freight_ratio" disabled placeholder="0%" />
    </div>

    <!-- ğŸ§¾ æˆæœ¬ä¸é”€å”®ç»†èŠ‚ -->
    <h2 class="full">ğŸ§¾ æˆæœ¬ä¸é”€å”®ç»†èŠ‚</h2>

    <label for="local">æœ¬åœ°è¿è¾“</label>
    <label for="moss">è‹”è—“</label>
    <input id="local" type="text" inputmode="decimal" placeholder="0.00" />
    <input id="moss" type="text" inputmode="decimal" placeholder="0.00" />

    <label for="pot">èŠ±ç›†</label>
    <label for="base_cost">åŸæˆæœ¬</label>
    <input id="pot" type="text" inputmode="decimal" placeholder="0.00" />
    <input id="base_cost" disabled placeholder="0.00" />

    <div id="priceSummary" class="full"></div>
    
    <!-- å‘è´§å‡†å¤‡æŒ‰é’® -->
    <button type="button" id="prepareShipping" onclick="enableShippingFields()">
      âœˆï¸ å‡†å¤‡å‘è´§ä¿¡æ¯
    </button>
  </form>

<script>
/* ======================== å…¨å±€é…ç½® ======================== */
const firebaseConfig = {
  apiKey: "11.8b2c9E9A5e5jc7ec8eUgN5aTnafF8efE-11F",
  authDomain: "bureau-line-system.firebaseapp.com",
  projectId: "bureau-line-system",
  storageBucket: "bureau-line-system.appspot.com",
  messagingSenderId: "88a487c2888",
  appId: "1:8880487c2888:web:19freeNetTo164d8011673"
};

const rateMap = { CNY: 1 / 1.55, NTD: 0.15, VND: 0.00018, IDR: 0.00028 };
let app, db; // Firebaseå®ä¾‹
let isShippingReady = false;
let formDirty = false;
let lastAutoSaveTS = 0;

/* ======================== Firebaseåˆå§‹åŒ– ======================== */
async function initFirebase() {
  try {
    // åŠ¨æ€åŠ è½½Firebase SDK
    await Promise.all([
      loadScript("https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"),
      loadScript("https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js")
    ]);
    
    // åˆå§‹åŒ–Firebase
    app = firebase.initializeApp(firebaseConfig);
    db = firebase.firestore();
    
    // æµ‹è¯•è¿æ¥
    await db.collection("connection_test").doc("init").set({
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    console.log("ğŸ”¥ Firebase åˆå§‹åŒ–æˆåŠŸ");
    
    // å¯ç”¨ç¦»çº¿æŒä¹…åŒ–ï¼ˆå¯é€‰ï¼‰
    try {
      await db.enablePersistence();
      console.log("ç¦»çº¿æŒä¹…åŒ–å·²å¯ç”¨");
    } catch (err) {
      console.warn("ç¦»çº¿æŒä¹…åŒ–ä¸å¯ç”¨:", err);
    }
  } catch (err) {
    console.error("Firebase åˆå§‹åŒ–å¤±è´¥:", err);
    showError("Firebaseåˆå§‹åŒ–å¤±è´¥: " + err.message);
  }
}

/* ======================== æ•°æ®æ“ä½œ ======================== */
async function saveRecordToFirebase() {
  if (!db) throw new Error("Firestore æœªåˆå§‹åŒ–");

  // å‡†å¤‡æ•°æ®
  const docData = {
    // é‡‡è´­ä¿¡æ¯
    supplier: document.getElementById("supplier").value.trim(),
    variety: document.getElementById("variety").value.trim(),
    currency: document.getElementById("currency").value,
    unit_price_foreign: parseNum(document.getElementById("price").value),
    unit_price_rm: parseNum(document.getElementById("price_rm").value),
    quantity: parseInt(document.getElementById("quantity").value),
    image_url: document.getElementById("image_url").value.trim(),
    
    // çŠ¶æ€ä¿¡æ¯
    status: isShippingReady ? "å¾…å‘è´§" : "é‡‡è´­ä¸­",
    created_at: firebase.firestore.FieldValue.serverTimestamp(),
    updated_at: firebase.firestore.FieldValue.serverTimestamp()
  };

  // å‘è´§ä¿¡æ¯
  if (isShippingReady) {
    Object.assign(docData, {
      shipment_id: document.getElementById("shipment_id").value.trim(),
      total_plants: parseInt(document.getElementById("total_plants").value),
      total_amount_rm: parseNum(document.getElementById("total_amount").value),
      packing: document.getElementById("packing").value.trim(),
      warehouse_date: document.getElementById("warehouse_date").value.trim(),
      container_date: document.getElementById("container_date").value.trim(),
      shipping_no: document.getElementById("shipping_no").value.trim(),
      arrival_date: document.getElementById("arrival_date").value.trim(),
      transit_days: parseInt(document.getElementById("days").value),
      freight_fee: parseNum(document.getElementById("freight_fee").value),
      freight_ratio: document.getElementById("freight_ratio").value,
      status: "å·²å®Œæˆ"
    });
  }

  // æˆæœ¬ä¿¡æ¯
  Object.assign(docData, {
    local_transport: parseNum(document.getElementById("local").value),
    moss: parseNum(document.getElementById("moss").value),
    pot: parseNum(document.getElementById("pot").value),
    base_cost: parseNum(document.getElementById("base_cost").value)
  });

  try {
    console.log("æ­£åœ¨å†™å…¥æ•°æ®:", docData);
    const docRef = await db.collection("bonsai_records").add(docData);
    console.log("æ–‡æ¡£å†™å…¥æˆåŠŸï¼ŒID:", docRef.id);
    
    // éªŒè¯å†™å…¥
    const savedDoc = await docRef.get();
    if (!savedDoc.exists) throw new Error("æ–‡æ¡£å†™å…¥åéªŒè¯å¤±è´¥");
    
    // æ›´æ–°å†å²è®°å½•
    addToHistory("supplier", docData.supplier);
    addToHistory("variety", docData.variety);
    
    return true;
  } catch (err) {
    console.error("å†™å…¥è¿‡ç¨‹ä¸­å‡ºé”™:", err);
    throw err;
  }
}

/* ======================== è¡¨å•åŠŸèƒ½ ======================== */
function enableShippingFields() {
  if (!validatePurchaseFields()) {
    showError("è¯·å…ˆå®Œæˆæ‰€æœ‰å¿…å¡«é‡‡è´­ä¿¡æ¯");
    return;
  }

  document.querySelectorAll(".shipping-field").forEach(field => {
    field.disabled = false;
  });
  
  document.getElementById("total_plants").value = document.getElementById("quantity").value;
  updateTotalAmount();
  
  isShippingReady = true;
  document.getElementById("form-status").textContent = "å¾…å‘è´§";
  document.getElementById("form-status").className = "status-badge status-shipping";
  document.getElementById("prepareShipping").textContent = "âœ… å‘è´§ä¿¡æ¯å·²å‡†å¤‡";
  document.getElementById("prepareShipping").style.backgroundColor = "#198754";
  
  document.getElementById("shipment_id").focus();
}

function validatePurchaseFields() {
  const requiredFields = ["supplier", "variety", "price", "quantity"];
  let isValid = true;
  
  requiredFields.forEach(id => {
    const field = document.getElementById(id);
    if (!field.value.trim()) {
      field.classList.add("error");
      isValid = false;
    } else {
      field.classList.remove("error");
    }
  });
  
  return isValid;
}

function validateBeforeSave() {
  if (!validatePurchaseFields()) return false;
  
  if (isShippingReady) {
    const requiredShippingFields = ["shipment_id", "warehouse_date"];
    let isValid = true;
    
    requiredShippingFields.forEach(id => {
      const field = document.getElementById(id);
      if (!field.value.trim()) {
        field.classList.add("error");
        isValid = false;
      } else {
        field.classList.remove("error");
      }
    });
    
    if (!isValid) {
      showError("è¯·å¡«å†™å®Œæ•´çš„å‘è´§ä¿¡æ¯");
      return false;
    }
    
    // éªŒè¯æ—¥æœŸ
    const datesValid = [
      validateDate(document.getElementById("warehouse_date"), document.getElementById("warehouse_date_error")),
      validateDate(document.getElementById("container_date"), document.getElementById("container_date_error")),
      validateDate(document.getElementById("arrival_date"), document.getElementById("arrival_date_error"))
    ].every(valid => valid);
    
    if (!datesValid) return false;
  }
  
  return true;
}

/* ======================== å·¥å…·å‡½æ•° ======================== */
function loadScript(src) {
  return new Promise((resolve, reject) => {
    const script = document.createElement("script");
    script.src = src;
    script.onload = resolve;
    script.onerror = () => reject(new Error(`è„šæœ¬åŠ è½½å¤±è´¥: ${src}`));
    document.head.appendChild(script);
  });
}

function showError(message) {
  // ç§»é™¤ç°æœ‰é”™è¯¯æç¤º
  const existingError = document.querySelector(".firebase-error");
  if (existingError) existingError.remove();
  
  const errorDiv = document.createElement("div");
  errorDiv.className = "firebase-error";
  errorDiv.textContent = message;
  document.body.appendChild(errorDiv);
  
  setTimeout(() => {
    errorDiv.remove();
  }, 5000);
}

function showAutoSaveStatus(txt, isError = false) {
  const el = document.getElementById("autoSaveStatus");
  el.textContent = txt;
  el.style.color = isError ? "red" : "#666";
}

function parseNum(str) {
  if (!str) return 0;
  const num = parseFloat(str.toString().replace(/,/g, ""));
  return isNaN(num) ? 0 : num;
}

function formatCurrency(val) {
  const num = parseFloat(stripCommas(val));
  if (isNaN(num)) return "";
  return num.toLocaleString("en-MY", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function stripCommas(v) {
  return v ? v.toString().replace(/,/g, "").trim() : "";
}

function validateDate(input, errorElement) {
  const rawDigits = input.value.replace(/[^0-9]/g, "");
  
  if (rawDigits.length === 6) {
    input.value = rawDigits.replace(/(\d{2})(\d{2})(\d{2})/, "$1/$2/$3");
  } else if (rawDigits.length === 8) {
    input.value = rawDigits.replace(/(\d{2})(\d{2})(\d{4})/, "$1/$2/$3");
  }

  const dt = parseDDMMYY(input.value);
  if (!dt) {
    input.classList.add("error");
    errorElement.style.display = "block";
    input.setCustomValidity("è¯·è¾“å…¥æœ‰æ•ˆæ—¥æœŸ");
    return false;
  } else {
    input.classList.remove("error");
    errorElement.style.display = "none";
    input.setCustomValidity("");
    if (input === document.getElementById("container_date") || 
        input === document.getElementById("arrival_date")) {
      updateDays();
    }
    return true;
  }
}

function parseDDMMYY(str) {
  if (!str) return null;
  const [d, m, y] = str.split("/").map(n => parseInt(n, 10));
  if (isNaN(d) || isNaN(m) || isNaN(y)) return null;
  const fullY = y < 100 ? 2000 + y : y;
  const dt = new Date(fullY, m - 1, d);
  if (dt.getFullYear() !== fullY || dt.getMonth() !== m - 1 || dt.getDate() !== d) return null;
  return dt;
}

/* ======================== åˆå§‹åŒ– ======================== */
window.addEventListener("load", async () => {
  await initFirebase();
  initForm();
});

function initForm() {
  // åˆå§‹åŒ–è¡¨å•é€»è¾‘...
  console.log("è¡¨å•åˆå§‹åŒ–å®Œæˆ");
}
</script>
</body>
</html>
