<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ç›†æ ½æˆæœ¬è®°å½•ç³»ç»Ÿ Lover Legend Gardening</title>
  <style>
    body {
      font-family: sans-serif;
      background-color: #f5f5f5;
      margin: 0;
      padding: 20px;
    }
    h1 { text-align: center; margin-bottom: 10px; }
    form {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      max-width: 1000px;
      margin: auto;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px 20px;
    }
    label {
      font-weight: bold;
      font-size: 14px;
    }
    input, select {
      width: 100%;
      padding: 6px 8px;
      font-size: 14px;
      box-sizing: border-box;
    }
    .full { grid-column: 1 / -1; }
    .error {
      border: 2px solid red !important;
      background-color: #ffe6e6 !important;
    }
    #autoSaveStatus {
      font-size: 12px;
      color: #666;
      margin-left: 8px;
    }
  </style>
</head>
<body>
  <h1>ç›†æ ½æˆæœ¬è®°å½•ç³»ç»Ÿ Lover Legend Gardening</h1>

  <form id="bonsaiForm" autocomplete="off">
    <label for="supplier">ä¾›åº”å•†</label>
    <input id="supplier" />

    <label for="variety">å“ç§</label>
    <input id="variety" />

    <label for="currency">å¸å€¼</label>
    <select id="currency">
      <option value="CNY">CNY</option>
      <option value="VND">VND</option>
      <option value="NTD">NTD</option>
      <option value="IDR">IDR</option>
    </select>

    <label for="price">å•ä»·ï¼ˆåŸå¸ï¼‰</label>
    <input id="price" type="text" placeholder="0.00" />

    <label for="price_rm">RM æœ¬é’±ï¼ˆè‡ªåŠ¨ï¼‰</label>
    <input id="price_rm" type="text" disabled placeholder="0.00" />

    <label for="quantity">æ•°é‡</label>
    <input id="quantity" type="number" placeholder="0" />

    <label for="shipment_id">å‘è´§å•å·</label>
    <input id="shipment_id" />

    <label for="total_plants">å‘è´§æ€»æ•°</label>
    <input id="total_plants" type="number" />

    <label for="total_amount">å‘è´§æ€»é‡‘é¢ï¼ˆRMè‡ªåŠ¨ï¼‰</label>
    <input id="total_amount" type="text" disabled />

    <label for="container_date">è£…æŸœæ—¥æœŸ (DDMMYY)</label>
    <input id="container_date" class="date-input" placeholder="DDMMYY" />

    <label for="arrival_date">æŠµè¾¾æ—¥æœŸ (DDMMYY)</label>
    <input id="arrival_date" class="date-input" placeholder="DDMMYY" />

    <label for="days">è¿è¾“å¤©æ•°</label>
    <input id="days" type="text" disabled />

    <label for="freight_fee">è¿è´¹ï¼ˆRMï¼‰</label>
    <input id="freight_fee" type="text" placeholder="0.00" />

    <label for="freight_ratio">è¿è´¹æ¯”ä¾‹</label>
    <input id="freight_ratio" type="text" disabled />

    <label for="local">æœ¬åœ°è¿è¾“</label>
    <input id="local" type="text" placeholder="0.00" />

    <label for="moss">è‹”è—“</label>
    <input id="moss" type="text" placeholder="0.00" />

    <label for="pot">èŠ±ç›†</label>
    <input id="pot" type="text" placeholder="0.00" />

    <label for="base_cost">æ€»æˆæœ¬ï¼ˆè‡ªåŠ¨ï¼‰</label>
    <input id="base_cost" type="text" disabled />

    <div class="full">
      <button type="button" onclick="manualSave()">ğŸ“‚ æ‰‹åŠ¨å‚¨å­˜</button>
      <span id="autoSaveStatus"></span>
    </div>
  </form>

  <script>
    // âœ… æ±‡ç‡è¡¨
    const rateMap = {
      CNY: 1 / 1.55,
      NTD: 0.15,
      VND: 0.00018,
      IDR: 0.00028
    };

    const $ = id => document.getElementById(id);
    const inputs = [
      "supplier","variety","currency","price","quantity","shipment_id",
      "total_plants","container_date","arrival_date",
      "freight_fee","local","moss","pot"
    ];
    inputs.forEach((id, i) => {
      $(id).addEventListener('keydown', e => {
        if (e.key === 'Enter') {
          e.preventDefault();
          if (e.target.classList.contains('date-input') && !validateDate(e.target)) return;
          const next = inputs[i + 1];
          if (next) $(next).focus();
        }
      });
    });

    function strip(v) {
      return v.replace(/,/g, '');
    }

    function num(v) {
      const n = parseFloat(strip(v));
      return isNaN(n) ? 0 : n;
    }

    function format(v) {
      const n = parseFloat(strip(v));
      if (isNaN(n)) return '';
      return n.toLocaleString('en-MY', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function formatPercent(val) {
      return isNaN(val) ? '0%' : (val * 100).toFixed(2) + '%';
    }

    function todayDDMMYY() {
      const now = new Date();
      return now.toLocaleDateString('en-GB').split('/').join('');
    }

    function parseDDMMYY(str) {
      const [d,m,y] = [str.slice(0,2), str.slice(2,4), str.slice(4,6)].map(n => parseInt(n, 10));
      if (isNaN(d) || isNaN(m) || isNaN(y)) return null;
      const fullY = 2000 + y;
      const dt = new Date(fullY, m - 1, d);
      return (dt.getDate() === d && dt.getMonth() === m - 1) ? dt : null;
    }

    function validateDate(input) {
      const clean = input.value.replace(/\D/g, '');
      if (clean.length === 6) input.value = clean;
      const dt = parseDDMMYY(input.value);
      if (!dt) {
        input.classList.add('error');
        input.setCustomValidity('è¯·è¾“å…¥æœ‰æ•ˆæ—¥æœŸ');
        input.reportValidity();
        return false;
      } else {
        input.classList.remove('error');
        input.setCustomValidity('');
        updateDays();
        return true;
      }
    }

    function updateRM() {
      const r = rateMap[$("currency").value] || 0;
      const p = num($("price").value);
      const rm = r * p;
      $("price_rm").value = format(rm);
      updateTotalAmount();
      updateBaseCost();
    }

    function updateTotalAmount() {
      const qty = num($("total_plants").value);
      const price = num($("price_rm").value);
      $("total_amount").value = format(qty * price);
      updateFreightRatio();
    }

    function updateDays() {
      const d1 = parseDDMMYY($("container_date").value);
      const d2 = parseDDMMYY($("arrival_date").value);
      if (!d1 || !d2) return;
      const diff = Math.max(0, (d2 - d1) / (1000 * 60 * 60 * 24));
      $("days").value = diff;
    }

    function updateFreightRatio() {
      const freight = num($("freight_fee").value);
      const total = num($("total_amount").value);
      $("freight_ratio").value = total > 0 ? formatPercent(freight / total) : '0%';
    }

    function updateBaseCost() {
      const unit = num($("price_rm").value);
      const qty = num($("quantity").value);
      const local = num($("local").value);
      const moss = num($("moss").value);
      const pot = num($("pot").value);
      $("base_cost").value = format(unit * qty + local + moss + pot);
    }

    ["currency", "price"].forEach(id => $(id).addEventListener('input', updateRM));
    ["quantity", "local", "moss", "pot"].forEach(id => $(id).addEventListener('input', updateBaseCost));
    ["total_plants"].forEach(id => $(id).addEventListener('input', updateTotalAmount));
    ["freight_fee"].forEach(id => $(id).addEventListener('input', updateFreightRatio));
    ["container_date", "arrival_date"].forEach(id => $(id).addEventListener('blur', e => validateDate(e.target)));

    // âœ… Firebase åˆå§‹åŒ–
    let db;
    (async function initFirebase() {
      const firebaseConfig = {
        apiKey: "AIzaSyCKQFkAz5jcTvCAMUpWSJ1nuEP8mEE-l18",
        authDomain: "bonsai-live-system.firebaseapp.com",
        projectId: "bonsai-live-system",
        storageBucket: "bonsai-live-system.appspot.com",
        messagingSenderId: "804874268810",
        appId: "1:804874268810:web:9d1ede421c16643d01fd73"
      };
      await loadScript("https://www.gstatic.com/firebasejs/11.0.0/firebase-app-compat.js");
      await loadScript("https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore-compat.js");
      firebase.initializeApp(firebaseConfig);
      db = firebase.firestore();
      console.log("ğŸ”¥ Firebase åˆå§‹åŒ–å®Œæˆ");
    })();

    function loadScript(src) {
      return new Promise((res, rej) => {
        const s = document.createElement("script");
        s.src = src;
        s.onload = res;
        s.onerror = rej;
