<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ç›†æ ½æˆæœ¬è®°å½•ç³»ç»Ÿ Lover Legend Gardening</title>
<style>
  body {
    font-family: sans-serif;
    background-color: #f5f5f5;
    margin: 0;
    padding: 20px;
  }
  .header {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    margin-bottom: 10px;
  }
  .header img { height: 50px; }
  .header h1 {
    font-size: 24px;
    margin: 0;
  }
  h2 {
    font-size: 18px;
    text-align: center;
    margin: 5px 0 15px;
    grid-column: 1 / -1;
  }
  form {
    background: #fff;
    padding: 20px;
    border-radius: 12px;
    max-width: 1000px;
    margin: auto;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px 20px;
  }
  label {
    font-weight: bold;
    font-size: 14px;
  }
  input, select, textarea {
    width: 100%;
    padding: 6px 8px;
    font-size: 14px;
    box-sizing: border-box;
    white-space: pre-wrap;
    overflow: hidden;
  }
  input::placeholder { color:#999; }
  .currency-placeholder { color:#999; }
  input[type=number]::-webkit-inner-spin-button,
  input[type=number]::-webkit-outer-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }
  .full { grid-column: 1 / -1; }
  .highlight { color: red; font-weight: bold; }
  .error {
    border: 2px solid red !important;
    background-color: #ffe6e6 !important;
  }
  .url-link {
    color: blue;
    text-decoration: underline;
    cursor: pointer;
  }
  .row3 { display: flex; gap: 6px; }
  .row3 > * { flex: 1; }
  .entry {
    font-size: 16px;
    margin-top: 4px;
  }
  .top-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    grid-column: 1 / -1;
  }
  .top-bar button {
    font-size: 14px;
    padding: 4px 10px;
    cursor: pointer;
  }
  /* å°å‹çŠ¶æ€æç¤º */
  #autoSaveStatus {
    font-size:12px;
    color:#666;
    margin-left:8px;
  }
  /* datalist ä¸‹æ‹‰æŒ‰é’®å…¼å®¹ */
  .with-datalist::-webkit-calendar-picker-indicator {
    display: none !important;
  }
  /* å‘è´§æŒ‰é’®æ ·å¼ */
  #markAsShipped {
    background-color: #4CAF50;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    grid-column: 1 / -1;
    margin-top: 10px;
  }
  #markAsShipped:hover {
    background-color: #45a049;
  }
  /* æ—¥æœŸé”™è¯¯æç¤º */
  .date-error {
    color: red;
    font-size: 12px;
    margin-top: -10px;
    margin-bottom: 5px;
    grid-column: 1 / -1;
    display: none;
  }
  /* å‘è´§çŠ¶æ€æ ·å¼ */
  .shipping-status {
    grid-column: 1 / -1;
    text-align: center;
    padding: 8px;
    margin: 5px 0;
    border-radius: 4px;
    font-weight: bold;
  }
  .status-purchased {
    background-color: #ffeb3b;
    color: #000;
  }
  .status-shipped {
    background-color: #4caf50;
    color: white;
  }
</style>
</head>
<body>
  <div class="header">
    <img src="logo.png" alt="logo">
    <h1>ç›†æ ½æˆæœ¬è®°å½•ç³»ç»Ÿ Lover Legend Gardening</h1>
  </div>

  <form id="bonsaiForm" autocomplete="off">
    <!-- éšè—çŠ¶æ€å­—æ®µ -->
    <input type="hidden" id="record_status" value="purchased">
    
    <!-- çŠ¶æ€æ˜¾ç¤º -->
    <div id="statusDisplay" class="shipping-status status-purchased">çŠ¶æ€ï¼šè´­ä¹°è®°å½•</div>
    
    <!-- ğŸŒ± ç›†æ ½èµ„æ–™ï¼ˆå«å†…é™†å‘è´§ä¿¡æ¯ï¼‰ -->
    <div class="top-bar">
      <h2>ğŸŒ± ç›†æ ½èµ„æ–™ï¼ˆå«å†…é™†å‘è´§ä¿¡æ¯ï¼‰</h2>
      <div>
        <span id="autoSaveStatus"></span>
        <button type="button" onclick="manualSave()">ğŸ“‚ æ‰‹åŠ¨å‚¨å­˜å…¨éƒ¨èµ„æ–™</button>
      </div>
    </div>

    <label for="supplier">ä¾›åº”å•†</label><label for="variety">å“ç§</label>
    <!-- datalist for å†å² -->
    <input id="supplier" list="supplierHistory" class="with-datalist" />
    <input id="variety"  list="varietyHistory"  class="with-datalist" />
    <datalist id="supplierHistory"></datalist>
    <datalist id="varietyHistory"></datalist>

    <label>å¸å€¼ + å•ä»·ï¼ˆåŸå¸ï¼‰+ RM æœ¬é’±</label><label for="quantity">æ•°é‡ï¼ˆæ£µï¼‰</label>
    <div class="row3">
      <select id="currency">
        <option value="CNY">CNY</option>
        <option value="VND">VND</option>
        <option value="NTD">NTD</option>
        <option value="IDR">IDR</option>
      </select>
      <input id="price" type="text" inputmode="decimal" placeholder="0.00" />
      <input id="price_rm" disabled placeholder="0.00" />
    </div>
    <input id="quantity" type="number" inputmode="numeric" pattern="[0-9]*" placeholder="0" />

    <label for="image_url">å›¾ç‰‡ç½‘å€</label><label for="shipment_id">å‘è´§å•å·</label>
    <input id="image_url" type="url" class="url-link" placeholder="https://..." onclick="openImageUrl(this)" />
    <input id="shipment_id" placeholder="ä¾‹å¦‚ 2025CNY01" readonly />

    <!-- ğŸš› å‘è´§èµ„æ–™ -->
    <h2 class="full">ğŸš› å‘è´§èµ„æ–™</h2>

    <label for="total_plants">å‘è´§æ€»æ•°</label><label for="total_amount">å‘è´§æ€»é‡‘é¢ï¼ˆRMè‡ªåŠ¨ï¼‰</label>
    <input id="total_plants" type="number" inputmode="numeric" pattern="[0-9]*" placeholder="0" readonly />
    <input id="total_amount" disabled placeholder="0.00" />

    <label for="packing">åŒ…è£…æ˜ç»†ï¼ˆæœ¨æ¶ï¼Œç®±å­ï¼‰</label><label for="warehouse_date">æŠµè¾¾ä»“åº“æ—¥æœŸ</label>
    <input id="packing" type="text" placeholder="ä¾‹å¦‚ï¼š1æœ¨æ¶2ç®±å­" readonly />
    <input id="warehouse_date" class="date-input" placeholder="DD/MM/YY" readonly />
    <div id="warehouse_date_error" class="date-error">è¯·è¾“å…¥æœ‰æ•ˆçš„æ—¥æœŸæ ¼å¼ (DD/MM/YY)</div>

    <label for="container_date">è£…æŸœæ—¥æœŸ</label><label for="shipping_no">æµ·è¿å•å·</label>
    <input id="container_date" class="date-input" placeholder="DD/MM/YY" readonly />
    <div id="container_date_error" class="date-error">è¯·è¾“å…¥æœ‰æ•ˆçš„æ—¥æœŸæ ¼å¼ (DD/MM/YY)</div>
    <input id="shipping_no" readonly />

    <label for="arrival_date">æŠµè¾¾æ—¥æœŸ</label><label for="freight_fee">è¿è´¹ï¼ˆRMï¼‰</label>
    <input id="arrival_date" class="date-input" placeholder="DD/MM/YY" readonly />
    <div id="arrival_date_error" class="date-error">è¯·è¾“å…¥æœ‰æ•ˆçš„æ—¥æœŸæ ¼å¼ (DD/MM/YY)</div>
    <input id="freight_fee" type="text" inputmode="decimal" placeholder="0.00" readonly />

    <label for="days">è¿è¾“å¤©æ•°</label><label for="freight_ratio">è¿è´¹æ¯”ä¾‹ï¼ˆè‡ªåŠ¨ï¼‰</label>
    <input id="days" disabled placeholder="0" />
    <input id="freight_ratio" disabled placeholder="0%" />

    <!-- ğŸ§¾ æˆæœ¬ä¸é”€å”®ç»†èŠ‚ -->
    <h2 class="full">ğŸ§¾ æˆæœ¬ä¸é”€å”®ç»†èŠ‚</h2>

    <label for="local">æœ¬åœ°è¿è¾“</label><label for="moss">è‹”è—“</label>
    <input id="local" type="text" inputmode="decimal" placeholder="0.00" />
    <input id="moss"  type="text" inputmode="decimal" placeholder="0.00" />

    <label for="pot">èŠ±ç›†</label><label for="base_cost">åŸæˆæœ¬</label>
    <input id="pot"  type="text" inputmode="decimal" placeholder="0.00" />
    <input id="base_cost" disabled placeholder="0.00" />

    <div id="priceSummary" class="full"></div>
    
    <!-- å‘è´§æŒ‰é’® -->
    <button type="button" id="markAsShipped" onclick="markAsShipped()">æ ‡è®°ä¸ºå·²å‘è´§</button>
  </form>

<script>
/* ------------------------ åŸºæœ¬è®¾å®š ------------------------ */
const firebaseConfig = {
  apiKey: "AIzaSyCKQFkAz5jcTvCAMUpWSJ1nuEP8mEE-l18",
  authDomain: "bonsai-live-system.firebaseapp.com",
  projectId: "bonsai-live-system",
  storageBucket: "bonsai-live-system.appspot.com",
  messagingSenderId: "804874268810",
  appId: "1:804874268810:web:9d1ede421c16643d01fd73"
};

// æ­£ç¡®æ±‡ç‡ â†’ RMï¼š 1 å•ä½å¤–å¸ * rate = RM
// ä½ ç»™çš„ï¼šCNY=1/1.55, NTD=0.15, VND=0.00018, IDR=0.00028
const rateMap = { CNY: 1 / 1.55, NTD: 0.15, VND: 0.00018, IDR: 0.00028 };

/* ------------------------ Firebase åˆå§‹åŒ– ------------------------ */
let app, db;
(async function initFirebase(){
  try {
    // åŠ¨æ€åŠ è½½ Firebase CDNï¼ˆä»…åœ¨æµè§ˆå™¨ï¼Œæ—  Node æ‰“åŒ…é¡¾è™‘ï¼‰
    await loadScript("https://www.gstatic.com/firebasejs/11.0.0/firebase-app-compat.js");
    await loadScript("https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore-compat.js");
    app = firebase.initializeApp(firebaseConfig);
    db  = firebase.firestore();
    console.log("ğŸ”¥ Firebase åˆå§‹åŒ–å®Œæˆ");
  } catch(err){
    console.error("Firebase åˆå§‹åŒ–å¤±è´¥ï¼š", err);
    alert("Firebase åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–é…ç½®ã€‚");
  }
})();

/* ------------------------ å·¥å…·å‡½æ•° ------------------------ */
function loadScript(src){
  return new Promise((resolve, reject)=>{
    const s=document.createElement('script');
    s.src=src; s.onload=resolve; s.onerror=reject;
    document.head.appendChild(s);
  });
}

function openImageUrl(el){
  if(el.value && el.value.startsWith('http')) window.open(el.value, '_blank');
}

function stripCommas(v){ return v ? v.toString().replace(/,/g,'').trim() : ''; }

function parseNum(v){
  const num=parseFloat(stripCommas(v));
  return isNaN(num)?0:num;
}

function formatCurrency(val){
  const num = parseFloat(stripCommas(val));
  if(isNaN(num)) return '';
  return num.toLocaleString('en-MY',{minimumFractionDigits:2,maximumFractionDigits:2});
}

function formatPercent(val){
  if(isNaN(val)) return '0%';
  return (val*100).toFixed(2)+'%';
}

function todayDDMMYY(){
  const now=new Date();
  const dd=String(now.getDate()).padStart(2,'0');
  const mm=String(now.getMonth()+1).padStart(2,'0');
  const yy=String(now.getFullYear()).slice(-2);
  return `${dd}/${mm}/${yy}`;
}

function parseDDMMYY(str){
  if(!str) return null;
  const [d,m,y]=str.split('/').map(n=>parseInt(n,10));
  if(isNaN(d)||isNaN(m)||isNaN(y)) return null;
  // assume 20xx
  const fullY = 2000 + y;
  const dt=new Date(fullY, m-1, d);
  // quick range checks
  if(dt.getFullYear()!==fullY || dt.getMonth()!==m-1 || dt.getDate()!==d) return null;
  return dt;
}

/* ------------------------ DOM å–å€¼ ------------------------ */
const elSupplier     = document.getElementById('supplier');
const elVariety      = document.getElementById('variety');
const elCurrency     = document.getElementById('currency');
const elPrice        = document.getElementById('price');
const elPriceRM      = document.getElementById('price_rm');
const elQuantity     = document.getElementById('quantity');
const elImageUrl     = document.getElementById('image_url');
const elShipmentId   = document.getElementById('shipment_id');
const elTotalPlants  = document.getElementById('total_plants');
const elTotalAmount  = document.getElementById('total_amount');
const elPacking      = document.getElementById('packing');
const elWarehouseDt  = document.getElementById('warehouse_date');
const elContainerDt  = document.getElementById('container_date');
const elShippingNo   = document.getElementById('shipping_no');
const elArrivalDt    = document.getElementById('arrival_date');
const elFreightFee   = document.getElementById('freight_fee');
const elDays         = document.getElementById('days');
const elFreightRatio = document.getElementById('freight_ratio');
const elLocal        = document.getElementById('local');
const elMoss         = document.getElementById('moss');
const elPot          = document.getElementById('pot');
const elBaseCost     = document.getElementById('base_cost');
const elPriceSummary = document.getElementById('priceSummary');
const elAutoSaveStatus = document.getElementById('autoSaveStatus');
const elRecordStatus = document.getElementById('record_status');
const elStatusDisplay = document.getElementById('statusDisplay');

// æ—¥æœŸé”™è¯¯æç¤ºå…ƒç´ 
const elWarehouseDtError = document.getElementById('warehouse_date_error');
const elContainerDtError = document.getElementById('container_date_error');
const elArrivalDtError = document.getElementById('arrival_date_error');

/* ------------------------ å†å²ä¸‹æ‹‰ (localStorage) ------------------------ */
const SUPPLIER_STORE_KEY = 'bonsai_supplier_history_v1';
const VARIETY_STORE_KEY  = 'bonsai_variety_history_v1';

function loadHistoryOptions(){
  const supers = JSON.parse(localStorage.getItem(SUPPLIER_STORE_KEY)||'[]');
  const vars   = JSON.parse(localStorage.getItem(VARIETY_STORE_KEY)||'[]');
  fillDatalist('supplierHistory',supers);
  fillDatalist('varietyHistory',vars);
}

function fillDatalist(id,arr){
  const dl=document.getElementById(id);
  dl.innerHTML='';
  arr.forEach(v=>{
    const opt=document.createElement('option');
    opt.value=v;
    dl.appendChild(opt);
  });
}

function addToHistory(id,key){
  const raw=key.trim();
  if(!raw) return;
  const storeKey = id==='supplier'?SUPPLIER_STORE_KEY:VARIETY_STORE_KEY;
  const arr=JSON.parse(localStorage.getItem(storeKey)||'[]');
  if(!arr.includes(raw)){
    arr.push(raw);
    arr.sort();
    localStorage.setItem(storeKey,JSON.stringify(arr));
    loadHistoryOptions();
  }
}
loadHistoryOptions();

/* ------------------------ ä»·æ ¼ / æ±‡ç‡ & åˆ©æ¶¦å”®ä»· ------------------------ */
function updateRM(){
  const cur=elCurrency.value;
  const raw=parseNum(elPrice.value);
  const rate=rateMap[cur]||0;
  const rm=raw*rate;
  elPriceRM.value=isNaN(rm)?'':formatCurrency(rm);
  updateSalesPrices(rm);
  updateBaseCost();    // æˆæœ¬åŒº
}

function updateSalesPrices(rmCostPerPlant){
  // ä¿ç•™åŸé€»è¾‘å€æ•° (ä¸å˜)
  const prices={
    "20%": rmCostPerPlant * 1.26 * 1.12,
    "30%": rmCostPerPlant * 1.43 * 1.12,
    "40%": rmCostPerPlant * 1.67 * 1.12,
    "45%": rmCostPerPlant * 1.82 * 1.12,
    "50%": rmCostPerPlant * 2.00 * 1.12,
    "55%": rmCostPerPlant * 2.23 * 1.12
  };
  let html  = `<div class="entry"><strong>20% åˆ©æ¶¦å”®ä»·ï¼š</strong>RM ${formatCurrency(prices["20%"])}</div>`;
  html     += `<div class="entry"><strong>30% åˆ©æ¶¦å”®ä»·ï¼š</strong>RM ${formatCurrency(prices["30%"])}</div>`;
  html     += `<div class="entry"><strong>40% åˆ©æ¶¦å”®ä»·ï¼š</strong>RM ${formatCurrency(prices["40%"])}</div>`;
  html     += `<div class="entry"><strong>45% åˆ©æ¶¦å”®ä»·ï¼š</strong>RM ${formatCurrency(prices["45%"])}</div>`;
  html     += `<div class="entry" style="color:red;font-weight:bold;"><strong>50% åˆ©æ¶¦å”®ä»·ï¼š</strong>RM ${formatCurrency(prices["50%"])}</div>`;
  html     += `<div class="entry"><strong>55% åˆ©æ¶¦å”®ä»·ï¼š</strong>RM ${formatCurrency(prices["55%"])}</div>`;
  elPriceSummary.innerHTML = html;
}

/* ------------------------ å‘è´§æ€»é‡‘é¢ï¼ˆRMè‡ªåŠ¨ï¼‰ ------------------------ */
function updateTotalAmount(){
  const quantity = parseNum(elQuantity.value);
  const rmPerPlant = parseNum(elPriceRM.value);
  const total = quantity * rmPerPlant;
  elTotalAmount.value = total ? formatCurrency(total) : '';
  updateFreightRatio();
}

/* ------------------------ æ—¥æœŸæ ¡éªŒ ------------------------ */
function validateDate(input, errorElement){
  // è‡ªåŠ¨è¡¥ "/" æ ¼å¼
  const rawDigits = input.value.replace(/[^0-9]/g,'');
  if(!input.value.trim()){
    input.value = todayDDMMYY();
  }else if(rawDigits.length===6){
    input.value = rawDigits.replace(/(\d{2})(\d{2})(\d{2})/,'$1/$2/$3');
  }

  const dt=parseDDMMYY(input.value);
  if(!dt){
    input.classList.add('error');
    errorElement.style.display = 'block';
    input.setCustomValidity('è¯·è¾“å…¥æœ‰æ•ˆæ—¥æœŸ');
    input.reportValidity();
    return false;
  }else{
    input.classList.remove('error');
    errorElement.style.display = 'none';
    input.setCustomValidity('');
    // å¦‚æœæ˜¯æŠµè¾¾æ—¥æœŸæˆ–è£…æŸœæ—¥æœŸæ›´æ–° â†’ é‡ç®—è¿è¾“å¤©æ•°
    if(input===elContainerDt || input===elArrivalDt) updateDays();
    return true;
  }
}

/* ------------------------ è¿è¾“å¤©æ•° & è¿è´¹æ¯”ä¾‹ ------------------------ */
function updateDays(){
  const cdt=parseDDMMYY(elContainerDt.value);
  const adt=parseDDMMYY(elArrivalDt.value);
  if(!cdt || !adt){
    elDays.value='';
    return;
  }
  let days = (adt - cdt)/(1000*60*60*24);
  if(isNaN(days) || days<0) days=0;
  elDays.value = Math.round(days);
}

function updateFreightRatio(){
  const freight = parseNum(elFreightFee.value);
  const total   = parseNum(elTotalAmount.value);
  const ratio = total>0 ? (freight/total) : 0;
  elFreightRatio.value = formatPercent(ratio);
}

/* ------------------------ æˆæœ¬åŒºï¼šåŸæˆæœ¬ï¼ˆRMï¼‰ ------------------------ */
function updateBaseCost(){
  // åŸæˆæœ¬ = (RM æœ¬é’± Ã— æ•°é‡) + æœ¬åœ°è¿è¾“ + è‹”è—“ + èŠ±ç›†
  const rmPerPlant = parseNum(elPriceRM.value);
  const qty        = parseNum(elQuantity.value);
  const local      = parseNum(elLocal.value);
  const moss       = parseNum(elMoss.value);
  const pot        = parseNum(elPot.value);
  const base = (rmPerPlant*qty) + local + moss + pot;
  elBaseCost.value = base ? formatCurrency(base) : '';
}

/* ------------------------ æ ‡è®°ä¸ºå·²å‘è´§ ------------------------ */
function markAsShipped() {
  // å¯ç”¨å‘è´§ç›¸å…³å­—æ®µ
  document.getElementById('shipment_id').readOnly = false;
  document.getElementById('total_plants').readOnly = false;
  document.getElementById('packing').readOnly = false;
  document.getElementById('warehouse_date').readOnly = false;
  document.getElementById('container_date').readOnly = false;
  document.getElementById('shipping_no').readOnly = false;
  document.getElementById('arrival_date').readOnly = false;
  document.getElementById('freight_fee').readOnly = false;
  
  // è‡ªåŠ¨è®¡ç®—å‘è´§æ€»æ•°å’Œæ€»é‡‘é¢
  elTotalPlants.value = elQuantity.value;
  updateTotalAmount();
  
  // æ›´æ–°çŠ¶æ€
  document.getElementById('record_status').value = 'shipped';
  elStatusDisplay.textContent = 'çŠ¶æ€ï¼šå·²å‘è´§';
  elStatusDisplay.className = 'shipping-status status-shipped';
  
  alert('å·²æ ‡è®°ä¸ºå‘è´§çŠ¶æ€ï¼Œè¯·å¡«å†™å®Œæ•´å‘è´§ä¿¡æ¯åä¿å­˜');
}

/* ------------------------ è¾“å…¥äº‹ä»¶ç»‘å®š ------------------------ */
// æ±‡ç‡ä¸ RM
elCurrency.addEventListener('change', updateRM);
elPrice.addEventListener('input', updateRM);
elPrice.addEventListener('blur', ()=>{ elPrice.value=formatCurrency(elPrice.value); updateRM(); });
elQuantity.addEventListener('input', updateBaseCost);

// å‘è´§æ€»æ•° â†’ å‘è´§æ€»é‡‘é¢
elTotalPlants.addEventListener('input', updateTotalAmount);

// è¿è´¹ â†’ è¿è´¹æ¯”ä¾‹
elFreightFee.addEventListener('input', ()=>{ updateFreightRatio(); });
elFreightFee.addEventListener('blur', ()=>{ elFreightFee.value=formatCurrency(elFreightFee.value); updateFreightRatio(); });

// æœ¬åœ°è¿è¾“/è‹”è—“/èŠ±ç›†
[elLocal,elMoss,elPot].forEach(el=>{
  el.addEventListener('input', updateBaseCost);
  el.addEventListener('blur', ()=>{
    el.value=formatCurrency(el.value);
    updateBaseCost();
  });
});

// æ—¥æœŸ blur æ ¡éªŒ
elWarehouseDt.addEventListener('blur', ()=>validateDate(elWarehouseDt, elWarehouseDtError));
elContainerDt.addEventListener('blur', ()=>validateDate(elContainerDt, elContainerDtError));
elArrivalDt.addEventListener('blur', ()=>validateDate(elArrivalDt, elArrivalDtError));

/* ------------------------ Enter è·³æ ¼ ------------------------ */
const formFields = Array.from(document.querySelectorAll('#bonsaiForm input, #bonsaiForm select, #bonsaiForm textarea, #bonsaiForm button:not([type=button])'));
formFields.forEach((el,i)=>{
  el.addEventListener('keydown', e=>{
    if(e.key==='Enter'){
      // å¯¹æŒ‰é’®ä¸æˆª
      if(el.tagName==='BUTTON') return;
      e.preventDefault();
      // æ—¥æœŸæ ¡éªŒ
      if(el.classList.contains('date-input')){
        let errorElement;
        if(el === elWarehouseDt) errorElement = elWarehouseDtError;
        else if(el === elContainerDt) errorElement = elContainerDtError;
        else if(el === elArrivalDt) errorElement = elArrivalDtError;
        
        const ok=validateDate(el, errorElement);
        if(!ok) return; // é˜»æ­¢è·³æ ¼
      }
      // é‡‘é¢ç±»æ ¼å¼åŒ–ï¼ˆåœ¨è·³æ ¼å‰ï¼‰
      const id=el.id;
      if(['price','freight_fee','local','moss','pot'].includes(id)){
        el.value=formatCurrency(el.value);
      }
      // æ‰¾ä¸‹ä¸€ä¸ªå¯èšç„¦å…ƒç´ 
      let next=i+1;
      while(next<formFields.length && (formFields[next].disabled || formFields[next].type==='hidden')) next++;
      if(formFields[next]) formFields[next].focus();
    }
  });
});

/* ------------------------ autoSave / manualSave ç›¸å…³ ------------------------ */
let lastAutoSaveTS=0;
let formDirty=false;

document.getElementById('bonsaiForm').addEventListener('input', ()=>{ formDirty=true; });

function showAutoSaveStatus(txt,isError=false){
  elAutoSaveStatus.textContent=txt;
  elAutoSaveStatus.style.color=isError?'red':'#666';
}

async function manualSave(){
  const ok = validateFormBeforeSave();
  if(!ok){ alert('âš ï¸ è¯·å…ˆä¿®æ­£é”™è¯¯å†å‚¨å­˜ã€‚'); return; }
  try{
    await saveRecordToFirebase();
    alert("âœ… èµ„æ–™å·²å‚¨å­˜ï¼");
  }catch(err){
    console.error(err);
    alert("âŒ å‚¨å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–é…ç½®ã€‚");
  }
}

function validateFormBeforeSave(){
  // æ ¡éªŒæœ€æ ¸å¿ƒå­—æ®µï¼ˆä¾›åº”å•†ã€å“ç§ã€å¸å€¼ã€å•ä»·ã€æ•°é‡ï¼‰
  if(!elSupplier.value.trim()){ alert('è¯·è¾“å…¥ä¾›åº”å•†'); elSupplier.focus(); return false; }
  if(!elVariety.value.trim()){ alert('è¯·è¾“å…¥å“ç§'); elVariety.focus(); return false; }
  
  // å¦‚æœæ˜¯å‘è´§çŠ¶æ€ï¼Œéœ€è¦æ ¡éªŒå‘è´§ç›¸å…³å­—æ®µ
  if(elRecordStatus.value === 'shipped') {
    if(!elShipmentId.value.trim()){ alert('è¯·è¾“å…¥å‘è´§å•å·'); elShipmentId.focus(); return false; }
    
    // æ ¡éªŒæ‰€æœ‰æ—¥æœŸ
    const warehouseValid = validateDate(elWarehouseDt, elWarehouseDtError);
    const containerValid = validateDate(elContainerDt, elContainerDtError);
    const arrivalValid = validateDate(elArrivalDt, elArrivalDtError);
    
    if(!warehouseValid || !containerValid || !arrivalValid) return false;
  }
  return true;
}

/* ------------------------ ä¿å­˜åˆ° Firebase ------------------------ */
async function saveRecordToFirebase(){
  if(!db){ throw new Error('Firebase Firestore æœªåˆå§‹åŒ–'); }
  
  const recordStatus = elRecordStatus.value;
  const isShipped = recordStatus === 'shipped';
  
  const docData = {
    supplier: elSupplier.value.trim() || '',
    variety: elVariety.value.trim() || '',
    currency: elCurrency.value,
    unit_price_foreign: parseNum(elPrice.value),
    unit_price_rm: parseNum(elPriceRM.value),
    quantity: parseNum(elQuantity.value),
    status: recordStatus,
    created_at: new Date().toISOString()
  };
  
  // å¦‚æœæ˜¯å‘è´§çŠ¶æ€ï¼Œæ·»åŠ å‘è´§ç›¸å…³ä¿¡æ¯
  if (isShipped) {
    docData.shipment_id = elShipmentId.value.trim() || '';
    docData.total_plants = parseNum(elTotalPlants.value);
    docData.total_amount_rm = parseNum(elPriceRM.value) * parseNum(elQuantity.value);
    docData.packing = elPacking.value.trim();
    
    // æ·»åŠ å…¶ä»–å‘è´§ç›¸å…³ä¿¡æ¯
    docData.container_date = elContainerDt.value.trim();
    docData.arrival_date = elArrivalDt.value.trim();
    docData.transit_days = parseNum(elDays.value);
    docData.freight_rm = parseNum(elFreightFee.value);
    docData.freight_ratio = elFreightRatio.value.trim();
    docData.image_url = elImageUrl.value.trim();
    docData.warehouse_date = elWarehouseDt.value.trim();
    docData.shipping_no = elShippingNo.value.trim();
  }

  // ä¿å­˜è®°å½•
  await db.collection('bonsai_records').add(docData);

  // å†™å…¥ localStorage å†å²
  addToHistory('supplier', elSupplier.value);
  addToHistory('variety', elVariety.value);

  formDirty = false;
  lastAutoSaveTS = Date.now();
  showAutoSaveStatus('å·²å‚¨å­˜ ' + new Date().toLocaleTimeString(), '#666');

  // å¦‚æœæ˜¯å‘è´§è®°å½•ï¼Œæ›´æ–°æ±‡æ€»
  if (isShipped) {
    aggregateShipments();
  }
}

/* ------------------------ æ¯ 3 åˆ†é’Ÿè‡ªåŠ¨å‚¨å­˜ ------------------------ */
const AUTO_SAVE_INTERVAL = 3 * 60 * 1000; // 3åˆ†é’Ÿ
setInterval(async()=>{
  if(!formDirty) return;
  const ok=validateFormBeforeSave();
  if(!ok){ showAutoSaveStatus('è‡ªåŠ¨å‚¨å­˜å¤±è´¥ï¼šè¡¨å•æœªé€šè¿‡éªŒè¯',true); return; }
  try{
    await saveRecordToFirebase();
    showAutoSaveStatus('è‡ªåŠ¨å‚¨å­˜å®Œæˆ '+new Date().toLocaleTimeString());
  }catch(err){
    console.error('è‡ªåŠ¨å‚¨å­˜å¤±è´¥',err);
    showAutoSaveStatus('è‡ªåŠ¨å‚¨å­˜å¤±è´¥',true);
  }
}, AUTO_SAVE_INTERVAL);

/* ------------------------ ç›¸åŒå‘è´§å•å·è‡ªåŠ¨æ±‡æ€»ï¼ˆå‰ç«¯ï¼‰ ------------------------ */
async function aggregateShipments(){
  if(!db) return;
  try{
    const snap=await db.collection('bonsai_records').orderBy('created_at','desc').limit(500).get();
    const groups={};
    snap.forEach(doc=>{
      const d=doc.data();
      const sid=d.shipment_id||'';
      if(!groups[sid]) groups[sid]={plants:0,amount:0,rows:0};
      // å¦‚æœ total_plants ==0 åˆ™ fallback quantity
      const p = d.total_plants>0?d.total_plants:d.quantity;
      const amt = d.total_amount_rm>0?d.total_amount_rm:(d.unit_price_rm * p);
      groups[sid].plants += p;
      groups[sid].amount += amt;
      groups[sid].rows++;
    });
    console.log('ğŸ“¦ å‘è´§å•å·æ±‡æ€»ï¼š',groups);
  }catch(err){
    console.error('æ±‡æ€»å¤±è´¥',err);
  }
}

/* ------------------------ åˆå§‹åŒ–ï¼šé»˜è®¤ä»Šå¤©æ—¥æœŸ & åˆå§‹è®¡ç®— ------------------------ */
(function initDefaults(){
  // æ—¥æœŸé»˜è®¤ä»Šå¤©ï¼ˆä¸è¦†ç›–å·²æœ‰ï¼‰
  [elWarehouseDt,elContainerDt,elArrivalDt].forEach(el=>{
    if(!el.value) el.value=todayDDMMYY();
  });
  updateRM();
  updateBaseCost();
  updateTotalAmount();
  updateFreightRatio();
  updateDays();
})();

/* ------------------------ é¡µé¢åŠ è½½åè‡ªåŠ¨èšç„¦ç¬¬ä¸€ä¸ªå­—æ®µ ------------------------ */
window.addEventListener('load',()=>{ elSupplier.focus(); });
</script>
</body>
</html>
