<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç›†æ ½æˆæœ¬è®°å½•ç³»ç»Ÿ Lover Legend Gardening</title>
  <style>
    body { font-family: sans-serif; background-color: #f5f5f5; padding: 10px; }
    .container { max-width: 1200px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 5px rgba(0,0,0,0.1); }
    h1 { text-align: center; margin-bottom: 20px; }
    .row { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
    .row label { min-width: 120px; font-weight: bold; }
    .row input, .row select { flex: 1; padding: 6px; font-size: 16px; }
    .row input:invalid { background-color: #ffecec; }
    .row input[type="date"]:invalid::after { content: 'è¯·è¾“å…¥æœ‰æ•ˆæ—¥æœŸ'; color: red; display: block; }
    .buttons { text-align: center; margin-top: 20px; }
    .buttons button { padding: 10px 20px; font-size: 16px; margin: 5px; cursor: pointer; }
    .results { margin-top: 20px; }
    .results .entry { margin: 5px 0; font-size: 18px; }
    .results .entry.red { color: red; font-weight: bold; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ç›†æ ½æˆæœ¬è®°å½•ç³»ç»Ÿ</h1>
    <div class="row">
      <label>ä¾›åº”å•†</label>
      <input id="supplier" list="supplierList" required />
      <datalist id="supplierList"></datalist>
    </div>
    <div class="row">
      <label>å“ç§</label>
      <input id="species" list="speciesList" required />
      <datalist id="speciesList"></datalist>
    </div>
    <div class="row">
      <label>å¸å€¼</label>
      <select id="currency">
        <option value="CNY">CNY</option>
        <option value="NTD">NTD</option>
        <option value="VND">VND</option>
        <option value="IDR">IDR</option>
      </select>
      <label>å•ä»·</label>
      <input type="number" id="unitPrice" />
      <label>RM æœ¬é’±</label>
      <input id="rmPrice" readonly />
    </div>
    <div class="row">
      <label>æ•°é‡</label>
      <input type="number" id="quantity" min="0" step="1" />
    </div>
    <div class="row">
      <label>èŠ±ç›†</label>
      <input type="number" id="potCost" />
      <label>è‹”è—“</label>
      <input type="number" id="mossCost" />
      <label>è¿è¾“</label>
      <input type="number" id="transportCost" />
    </div>
    <div class="row">
      <label>è£…æŸœæ—¥æœŸ</label>
      <input type="date" id="shipDate" />
      <label>æŠµè¾¾æ—¥æœŸ</label>
      <input type="date" id="arrivalDate" />
      <label>è¿è¾“å¤©æ•°</label>
      <input id="days" readonly />
    </div>
    <div class="row">
      <label>å‘è´§å•å·</label>
      <input id="shipmentId" />
      <label>å‘è´§æ€»æ•°</label>
      <input type="number" id="totalShipmentQty" min="0" step="1" />
      <label>å‘è´§æ€»é‡‘é¢ï¼ˆRMè‡ªåŠ¨ï¼‰</label>
      <input id="totalShipmentCost" readonly />
    </div>
    <div class="row">
      <label>è¿è´¹ RM</label>
      <input type="number" id="freightRM" />
      <label>è¿è´¹æ¯”ä¾‹</label>
      <input id="freightRatio" readonly />
    </div>
    <div class="buttons">
      <button onclick="saveData()">ğŸ“‚ å‚¨å­˜èµ„æ–™åˆ° Firebase</button>
    </div>
    <div class="results" id="results"></div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCKQFkAzSjcTvCAMUpWSJ1nuEP8mEE-l18",
      authDomain: "bonsai-live-system.firebaseapp.com",
      projectId: "bonsai-live-system",
    };
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const currencyRate = { CNY: 1.55, NTD: 1 / 0.15, VND: 1 / 0.00018, IDR: 1 / 0.00028 };

    document.querySelectorAll("input, select").forEach(e => {
      e.addEventListener("keydown", ev => {
        if (ev.key === "Enter") {
          ev.preventDefault();
          const i = [...document.querySelectorAll("input, select")].indexOf(e);
          if (i >= 0 && i < document.querySelectorAll("input, select").length - 1) {
            document.querySelectorAll("input, select")[i + 1].focus();
          }
        }
      });
    });

    function formatCurrency(n) {
      return parseFloat(n || 0).toLocaleString('en-MY', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    setInterval(() => {
      const price = parseFloat(document.getElementById("unitPrice").value || 0);
      const currency = document.getElementById("currency").value;
      const rm = price * currencyRate[currency];
      document.getElementById("rmPrice").value = formatCurrency(rm);

      const pot = parseFloat(document.getElementById("potCost").value || 0);
      const moss = parseFloat(document.getElementById("mossCost").value || 0);
      const trans = parseFloat(document.getElementById("transportCost").value || 0);
      const totalCost = rm + pot + moss + trans;

      const results = document.getElementById("results");
      results.innerHTML = "";
      results.innerHTML += `<div class='entry'><strong>åŸå§‹æˆæœ¬ï¼š</strong>RM ${formatCurrency(rm)}</div>`;
      results.innerHTML += `<div class='entry'><strong>æ€»æˆæœ¬ï¼š</strong>RM ${formatCurrency(totalCost)}</div>`;

      const percents = ["20%", "30%", "40%", "50%", "55%"];
      percents.forEach(p => {
        const multiplier = 1 + parseInt(p) / 100;
        const price = totalCost * multiplier;
        results.innerHTML += `<div class='entry${p === "50%" ? " red" : ""}'><strong>${p} åˆ©æ¶¦å”®ä»·ï¼š</strong>RM ${formatCurrency(price)}</div>`;
      });

      const shipDate = new Date(document.getElementById("shipDate").value);
      const arrivalDate = new Date(document.getElementById("arrivalDate").value);
      if (shipDate.toString() !== "Invalid Date" && arrivalDate.toString() !== "Invalid Date") {
        const days = Math.round((arrivalDate - shipDate) / (1000 * 3600 * 24));
        document.getElementById("days").value = days;
      }

      const qty = parseFloat(document.getElementById("totalShipmentQty").value || 0);
      const shipmentCost = qty * rm;
      document.getElementById("totalShipmentCost").value = formatCurrency(shipmentCost);

      const freight = parseFloat(document.getElementById("freightRM").value || 0);
      const ratio = shipmentCost > 0 ? freight / shipmentCost : 0;
      document.getElementById("freightRatio").value = ratio.toFixed(4);
    }, 1000);

    async function saveData() {
      const record = {
        supplier: document.getElementById("supplier").value,
        species: document.getElementById("species").value,
        currency: document.getElementById("currency").value,
        unit_price: parseFloat(document.getElementById("unitPrice").value || 0),
        rm_price: parseFloat(document.getElementById("rmPrice").value.replace(/,/g, '')),
        quantity: parseInt(document.getElementById("quantity").value || 0),
        pot: parseFloat(document.getElementById("potCost").value || 0),
        moss: parseFloat(document.getElementById("mossCost").value || 0),
        transport: parseFloat(document.getElementById("transportCost").value || 0),
        ship_date: document.getElementById("shipDate").value,
        arrival_date: document.getElementById("arrivalDate").value,
        days: parseInt(document.getElementById("days").value || 0),
        shipment_id: document.getElementById("shipmentId").value,
        shipment_qty: parseInt(document.getElementById("totalShipmentQty").value || 0),
        shipment_rm: parseFloat(document.getElementById("totalShipmentCost").value.replace(/,/g, '')),
        freight_rm: parseFloat(document.getElementById("freightRM").value || 0),
        freight_ratio: parseFloat(document.getElementById("freightRatio").value || 0),
        created_at: new Date().toISOString(),
      };
      await db.collection("bonsai_records").add(record);
      alert("âœ… å‚¨å­˜æˆåŠŸ");
    }
  </script>
</body>
</html>
