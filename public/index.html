<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç›†æ ½æˆæœ¬è®°å½•ç³»ç»Ÿ Lover Legend Gardening</title>
  <style>
    body {
      font-family: sans-serif;
      background-color: #f5f5f5;
      margin: 0;
      padding: 20px;
    }
    .header-container {
      display: flex;
      justify-content: center;
      max-width: 1000px;
      margin: auto;
    }
    .header {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    .header img {
      height: 50px;
    }
    .header h1 {
      font-size: 24px;
      margin: 0;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: white;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      font-size: 14px;
    }
    th {
      background-color: #f2f2f2;
    }
    input, select {
      width: 100%;
      box-sizing: border-box;
      font-size: 14px;
      padding: 5px;
    }
    input:invalid {
      border: 2px solid red;
    }
    .save-btn {
      display: block;
      margin: 20px auto;
      padding: 10px 20px;
      font-size: 16px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .save-btn:hover {
      background-color: #45a049;
    }
    .currency {
      text-align: right;
    }
    input:focus {
      outline: 2px solid #4CAF50;
    }
    .summary-box {
      margin-top: 20px;
      padding: 15px;
      background: #fff7e6;
      border: 1px solid #ffe58f;
      border-radius: 5px;
      font-size: 16px;
    }
    .summary-box strong {
      display: inline-block;
      width: 180px;
    }
    .price-red {
      color: red;
      font-weight: bold;
    }
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCKQFkAz5jcTvCAMUpWSJ1nuEP8mEE-l18",
      authDomain: "bonsai-live-system.firebaseapp.com",
      projectId: "bonsai-live-system",
      storageBucket: "bonsai-live-system.appspot.com",
      messagingSenderId: "804874268810",
      appId: "1:804874268810:web:9d1ede421c16643d01fd73"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const rates = {
      CNY: 1 / 1.55,
      NTD: 0.15,
      VND: 0.00018,
      IDR: 0.00028
    };

    function formatMoney(value) {
      const num = parseFloat(value);
      return isNaN(num) ? '' : num.toLocaleString('en-MY', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function calculatePrices(rmCost) {
      const prices = {};
      ["20%", "30%", "40%", "50%", "55%"].forEach(rate => {
        const multiplier = 1 + parseFloat(rate) / 100;
        prices[rate] = rmCost * multiplier;
      });
      return prices;
    }

    function updateSummary(rmCost) {
      const prices = calculatePrices(rmCost);
      const html = `
        <div class="summary-box">
          <div><strong>å®é™…æˆæœ¬ï¼š</strong>RM ${formatMoney(rmCost)}</div>
          <div><strong>20% åˆ©æ¶¦å”®ä»·ï¼š</strong>RM ${formatMoney(prices["20%"])}</div>
          <div><strong>30% åˆ©æ¶¦å”®ä»·ï¼š</strong>RM ${formatMoney(prices["30%"])}</div>
          <div><strong>40% åˆ©æ¶¦å”®ä»·ï¼š</strong>RM ${formatMoney(prices["40%"])}</div>
          <div><strong>50% åˆ©æ¶¦å”®ä»·ï¼š</strong><span class="price-red">RM ${formatMoney(prices["50%"])}<span></div>
          <div><strong>55% åˆ©æ¶¦å”®ä»·ï¼š</strong>RM ${formatMoney(prices["55%"])}</div>
        </div>
      `;
      document.getElementById("priceSummary").innerHTML = html;
    }

    function calculateRow(row) {
      const currency = row.querySelector("[name='currency']").value;
      const unitPriceInput = row.querySelector("[name='unit_price']");
      const unitPrice = parseFloat(unitPriceInput.value.replace(/,/g, ''));
      const rmCostField = row.querySelector("[name='rm_cost']");
      const invoiceQty = parseFloat(row.querySelector("[name='invoice_qty']").value);
      const invoiceTotalField = row.querySelector("[name='invoice_total']");
      const shipDateInput = row.querySelector("[name='ship_date']");
      const arriveDateInput = row.querySelector("[name='arrive_date']");
      const daysField = row.querySelector("[name='days']");
      const shippingFeeInput = row.querySelector("[name='shipping_fee']");
      const shippingRateField = row.querySelector("[name='shipping_rate']");

      if (!isNaN(unitPrice)) {
        const rmCost = unitPrice * (rates[currency] || 0);
        if (!isNaN(rmCost)) {
          rmCostField.value = formatMoney(rmCost);
          updateSummary(rmCost);
        }

        const total = rmCost * invoiceQty;
        if (!isNaN(total)) invoiceTotalField.value = formatMoney(total);

        const shippingFee = parseFloat(shippingFeeInput.value.replace(/,/g, '')) || 0;
        const shippingRate = shippingFee / total;
        if (!isNaN(shippingRate) && isFinite(shippingRate)) shippingRateField.value = (shippingRate * 100).toFixed(2) + "%";
      }

      const shipDate = new Date(shipDateInput.value);
      const arriveDate = new Date(arriveDateInput.value);
      if (!isNaN(shipDate) && !isNaN(arriveDate)) {
        const diff = Math.ceil((arriveDate - shipDate) / (1000 * 3600 * 24));
        daysField.value = diff >= 0 ? diff : '';
      } else {
        daysField.value = '';
      }
    }

    async function saveAllRows() {
      const rows = document.querySelectorAll("#tableBody tr");
      for (const row of rows) {
        calculateRow(row);
        const data = {};
        const fields = [
          "supplier", "species", "currency", "unit_price", "rm_cost", "quantity",
          "invoice", "invoice_qty", "invoice_total", "ship_date", "arrive_date",
          "days", "shipping_fee", "shipping_rate", "image_url"
        ];
        fields.forEach((key) => {
          const input = row.querySelector(`[name='${key}']`);
          data[key] = input ? input.value : '';
        });
        try {
          await addDoc(collection(db, "bonsai_records"), data);
        } catch (e) {
          console.error("å‚¨å­˜å¤±è´¥: ", e);
        }
      }
      console.log("âœ… è‡ªåŠ¨å‚¨å­˜å®Œæ¯•");
    }

    window.saveData = async () => {
      await saveAllRows();
      alert("èµ„æ–™å·²æˆåŠŸå‚¨å­˜ï¼");
    };

    setInterval(saveAllRows, 3 * 60 * 1000); // æ¯3åˆ†é’Ÿè‡ªåŠ¨å‚¨å­˜

    document.addEventListener("input", e => {
      const target = e.target;
      if (target.name === 'unit_price' || target.name === 'shipping_fee') {
        target.value = formatMoney(target.value.replace(/,/g, ''));
      }
      const row = e.target.closest("tr");
      if (row) calculateRow(row);
    });

    document.addEventListener("keydown", e => {
      if (e.key === "Enter") {
        const inputs = Array.from(document.querySelectorAll("input, select"));
        const index = inputs.indexOf(document.activeElement);
        if (index > -1 && index < inputs.length - 1) {
          const next = inputs[index + 1];
          if (next) {
            e.preventDefault();
            next.focus();
          }
        }
      }
    });
  </script>
</head>
<body>
  <div class="header-container">
    <div class="header">
      <img src="favicon.png" alt="logo">
      <h1>ç›†æ ½æˆæœ¬è®°å½•ç³»ç»Ÿ Lover Legend Gardening</h1>
    </div>
  </div>

  <button class="save-btn" onclick="saveData()">ğŸ“‚ å‚¨å­˜èµ„æ–™åˆ° Firebase</button>

  <table id="bonsaiTable">
    <thead>
      <tr>
        <th>ä¾›åº”å•†</th>
        <th>å“ç§</th>
        <th>å¸å€¼</th>
        <th>å•ä»·ï¼ˆåŸå¸ï¼‰</th>
        <th>RM æœ¬é’±</th>
        <th>æ•°é‡</th>
        <th>å‘è´§å•å·</th>
        <th>å‘è´§æ€»æ•°</th>
        <th>å‘è´§æ€»é‡‘é¢ï¼ˆRMè‡ªåŠ¨ï¼‰</th>
        <th>è£…æŸœæ—¥æœŸ</th>
        <th>æŠµè¾¾æ—¥æœŸ</th>
        <th>è¿è¾“å¤©æ•°</th>
        <th>è¿è´¹ï¼ˆRMï¼‰</th>
        <th>è¿è´¹æ¯”ä¾‹</th>
        <th>å›¾ç‰‡ç½‘å€</th>
      </tr>
    </thead>
    <tbody id="tableBody">
      <tr>
        <td><input name="supplier" required></td>
        <td><input name="species" required></td>
        <td>
          <select name="currency">
            <option value="CNY">CNY</option>
            <option value="NTD">NTD</option>
            <option value="VND">VND</option>
            <option value="IDR">IDR</option>
          </select>
        </td>
        <td><input type="text" name="unit_price"></td>
        <td><input name="rm_cost" readonly></td>
        <td><input type="number" step="1" name="quantity"></td>
        <td><input name="invoice"></td>
        <td><input type="number" step="1" name="invoice_qty"></td>
        <td><input name="invoice_total" readonly></td>
        <td><input type="date" name="ship_date"></td>
        <td><input type="date" name="arrive_date"></td>
        <td><input name="days" readonly></td>
        <td><input name="shipping_fee"></td>
        <td><input name="shipping_rate" readonly></td>
        <td><input name="image_url"></td>
      </tr>
    </tbody>
  </table>

  <div id="priceSummary"></div>
</body>
</html>
