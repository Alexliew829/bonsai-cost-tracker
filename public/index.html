<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ç›†æ ½æˆæœ¬è®°å½•ç³»ç»Ÿ Lover Legend Gardening</title>
  <style>
    body { font-family: sans-serif; background-color: #f5f5f5; margin: 0; padding: 20px; }
    .header { display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 10px; }
    .header img { height: 50px; }
    .header h1 { font-size: 24px; margin: 0; }
    form {
      background: #fff; padding: 20px; border-radius: 12px; max-width: 1000px; margin: auto;
      display: grid; grid-template-columns: 1fr 1fr; gap: 12px 20px;
    }
    label { font-weight: bold; }
    input, select { padding: 8px; font-size: 16px; }
    input[disabled] { background-color: #eee; }
    .full { grid-column: 1 / -1; }
    .entry { font-size: 16px; margin-top: 4px; }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
</head>
<body>
  <div class="header">
    <img src="logo.png" alt="logo">
    <h1>ç›†æ ½æˆæœ¬è®°å½•ç³»ç»Ÿ Lover Legend Gardening</h1>
  </div>
  <form id="bonsaiForm">
    <label>ä¾›åº”å•†</label>
    <input id="supplier" list="supplierHistory">
    <label>å“ç§</label>
    <input id="variety" list="varietyHistory">
    <datalist id="supplierHistory"></datalist>
    <datalist id="varietyHistory"></datalist>

    <label>å¸å€¼</label>
    <select id="currency">
      <option value="CNY">CNY</option>
      <option value="NTD">NTD</option>
      <option value="VND">VND</option>
      <option value="IDR">IDR</option>
    </select>
    <label>å•ä»·ï¼ˆåŸå¸ï¼‰</label>
    <input id="price" type="text" inputmode="decimal" placeholder="0.00">
    <label>RM æœ¬é’±</label>
    <input id="price_rm" type="text" disabled placeholder="0.00">
    <label>æ•°é‡</label>
    <input id="quantity" type="number" inputmode="numeric" placeholder="0">

    <label>å›¾ç‰‡ç½‘å€</label>
    <input id="image_url" type="url">
    <label>å‘è´§å•å·</label>
    <input id="shipment_id">

    <label>å‘è´§æ€»æ•°</label>
    <input id="total_plants" type="number" disabled>
    <label>å‘è´§æ€»é‡‘é¢ï¼ˆRMï¼‰</label>
    <input id="total_amount" type="text" disabled>

    <label>è¿è´¹ï¼ˆRMï¼‰</label>
    <input id="freight_fee" type="text">
    <label>è¿è´¹æ¯”ä¾‹</label>
    <input id="freight_ratio" type="text" disabled>

    <div id="priceSummary" class="full"></div>

    <button type="button" onclick="manualSave()">å‚¨å­˜</button>
  </form>

<script>
const rateMap = { CNY: 1/1.55, NTD: 0.15, VND: 0.00018, IDR: 0.00028 };
const formatCurrency = n => parseFloat(n||0).toLocaleString('en-MY', { minimumFractionDigits: 2 });
const formatPercent = n => (parseFloat(n||0)*100).toFixed(2) + '%';
const parseNum = v => parseFloat((v || '').toString().replace(/,/g, '')) || 0;

const elForm = document.getElementById('bonsaiForm');
const elSupplier = document.getElementById('supplier');
const elVariety = document.getElementById('variety');
const elCurrency = document.getElementById('currency');
const elPrice = document.getElementById('price');
const elPriceRM = document.getElementById('price_rm');
const elQuantity = document.getElementById('quantity');
const elShipmentId = document.getElementById('shipment_id');
const elTotalPlants = document.getElementById('total_plants');
const elTotalAmount = document.getElementById('total_amount');
const elFreightFee = document.getElementById('freight_fee');
const elFreightRatio = document.getElementById('freight_ratio');
const elPriceSummary = document.getElementById('priceSummary');

function updateRM() {
  const rate = rateMap[elCurrency.value] || 0;
  const rm = parseNum(elPrice.value) * rate;
  elPriceRM.value = formatCurrency(rm);
  updateSalesPrices(rm);
}

function updateSalesPrices(rm) {
  const prices = {
    '20%': rm * 1.26 * 1.12,
    '30%': rm * 1.43 * 1.12,
    '40%': rm * 1.67 * 1.12,
    '45%': rm * 1.82 * 1.12,
    '50%': rm * 2.00 * 1.12,
    '55%': rm * 2.23 * 1.12,
  };
  elPriceSummary.innerHTML = Object.entries(prices).map(([k, v]) =>
    `<div class="entry"${k==='50%' ? ' style="color:red;font-weight:bold;"' : ''}><strong>${k} åˆ©æ¶¦å”®ä»·ï¼š</strong>RM ${formatCurrency(v)}</div>`
  ).join('');
}

function updateFreightRatio() {
  const freight = parseNum(elFreightFee.value);
  const total = parseNum(elTotalAmount.value);
  elFreightRatio.value = formatPercent(total ? freight / total : 0);
}

const fields = Array.from(elForm.querySelectorAll('input, select'));
fields.forEach((el, i) => {
  el.addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      e.preventDefault();
      if (["price", "freight_fee"].includes(el.id)) {
        el.value = formatCurrency(el.value);
        if (el.id === 'price') updateRM();
        if (el.id === 'freight_fee') updateFreightRatio();
      }
      let next = i + 1;
      while (fields[next] && (fields[next].disabled || fields[next].type === 'hidden')) next++;
      if (fields[next]) fields[next].focus();
    }
  });
  if (["price", "freight_fee"].includes(el.id)) {
    el.addEventListener('blur', () => {
      el.value = formatCurrency(el.value);
      if (el.id === 'price') updateRM();
      if (el.id === 'freight_fee') updateFreightRatio();
    });
  }
});

elCurrency.addEventListener('change', updateRM);
elPrice.addEventListener('input', updateRM);

const firebaseConfig = {
  apiKey: "AIzaSyCKQFkAz5jcTvCAMUpWSJ1nuEP8mEE-l18",
  authDomain: "bonsai-live-system.firebaseapp.com",
  projectId: "bonsai-live-system",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

function manualSave() {
  const data = {
    supplier: elSupplier.value,
    variety: elVariety.value,
    currency: elCurrency.value,
    price: parseNum(elPrice.value),
    price_rm: parseNum(elPriceRM.value),
    quantity: parseNum(elQuantity.value),
    image_url: document.getElementById('image_url').value,
    shipment_id: elShipmentId.value,
    freight_fee: parseNum(elFreightFee.value),
    timestamp: new Date()
  };
  db.collection("bonsai_records").add(data).then(() => alert("âœ… å‚¨å­˜æˆåŠŸ"));
  saveHistory(elSupplier, 'supplierHistory');
  saveHistory(elVariety, 'varietyHistory');
}

function saveHistory(input, listId) {
  const value = input.value;
  if (!value) return;
  const history = JSON.parse(localStorage.getItem(listId) || "[]");
  if (!history.includes(value)) {
    history.push(value);
    localStorage.setItem(listId, JSON.stringify(history));
    const list = document.getElementById(listId);
    list.innerHTML = history.map(v => `<option value="${v}">`).join('');
  }
}

// ğŸ” è‡ªåŠ¨å‚¨å­˜æ¯ 3 åˆ†é’Ÿ
setInterval(manualSave, 180000);

// ğŸ” æ ¹æ® shipment_id æ±‡æ€»å‘è´§æ•°æ®
elShipmentId.addEventListener('blur', async () => {
  const sid = elShipmentId.value.trim();
  if (!sid) return;
  const snap = await db.collection("bonsai_records").where("shipment_id", "==", sid).get();
  let totalQty = 0, totalRM = 0;
  snap.forEach(doc => {
    const d = doc.data();
    totalQty += d.quantity || 0;
    totalRM += (d.price_rm || 0) * (d.quantity || 0);
  });
  elTotalPlants.value = totalQty;
  elTotalAmount.value = formatCurrency(totalRM);
  updateFreightRatio();
});
</script>
</body>
</html>
