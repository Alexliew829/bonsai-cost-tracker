<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>盆栽成本记录系统 Lover Legend Gardening</title>
  <style>
    body { font-family: sans-serif; background-color: #f5f5f5; margin: 0; padding: 20px; }
    .header { display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 10px; }
    .header img { height: 50px; }
    .header h1 { font-size: 24px; margin: 0; }
    form {
      background: #fff; padding: 20px; border-radius: 12px; max-width: 1000px; margin: auto;
      display: grid; grid-template-columns: 1fr 1fr; gap: 12px 20px;
    }
    label { font-weight: bold; }
    input, select { padding: 8px; font-size: 16px; }
    input[disabled] { background-color: #eee; }
    .full { grid-column: 1 / -1; }
    .entry { font-size: 16px; margin-top: 4px; }
  </style>
</head>
<body>
  <div class="header">
    <img src="logo.png" alt="logo">
    <h1>盆栽成本记录系统 Lover Legend Gardening</h1>
  </div>
  <form id="bonsaiForm">
    <label>供应商</label>
    <input id="supplier" list="supplierHistory">
    <label>品种</label>
    <input id="variety" list="varietyHistory">
    <datalist id="supplierHistory"></datalist>
    <datalist id="varietyHistory"></datalist>

    <label>币值</label>
    <select id="currency">
      <option value="CNY">CNY</option>
      <option value="NTD">NTD</option>
      <option value="VND">VND</option>
      <option value="IDR">IDR</option>
    </select>
    <label>单价（原币）</label>
    <input id="price" type="text" inputmode="decimal" placeholder="0.00">
    <label>RM 本钱</label>
    <input id="price_rm" type="text" disabled placeholder="0.00">
    <label>数量</label>
    <input id="quantity" type="number" inputmode="numeric" placeholder="0">

    <label>图片网址</label>
    <input id="image_url" type="url">
    <label>发货单号</label>
    <input id="shipment_id">

    <label>发货总数</label>
    <input id="total_plants" type="number" disabled>
    <label>发货总金额（RM）</label>
    <input id="total_amount" type="text" disabled>

    <label>运费（RM）</label>
    <input id="freight_fee" type="text">
    <label>运费比例</label>
    <input id="freight_ratio" type="text" disabled>

    <div id="priceSummary" class="full"></div>

    <button type="button" onclick="manualSave()">储存</button>
  </form>

<script>
// ✅ 汇率设定
const rateMap = { CNY: 1/1.55, NTD: 0.15, VND: 0.00018, IDR: 0.00028 };

// ✅ 快捷函数
const formatCurrency = n => parseFloat(n||0).toLocaleString('en-MY', { minimumFractionDigits: 2 });
const formatPercent = n => (parseFloat(n||0)*100).toFixed(2) + '%';
const parseNum = v => parseFloat((v || '').toString().replace(/,/g, '')) || 0;

// ✅ 元素
const elForm = document.getElementById('bonsaiForm');
const elSupplier = document.getElementById('supplier');
const elVariety = document.getElementById('variety');
const elCurrency = document.getElementById('currency');
const elPrice = document.getElementById('price');
const elPriceRM = document.getElementById('price_rm');
const elQuantity = document.getElementById('quantity');
const elShipmentId = document.getElementById('shipment_id');
const elTotalPlants = document.getElementById('total_plants');
const elTotalAmount = document.getElementById('total_amount');
const elFreightFee = document.getElementById('freight_fee');
const elFreightRatio = document.getElementById('freight_ratio');
const elPriceSummary = document.getElementById('priceSummary');

// ✅ 汇率更新与利润售价
function updateRM() {
  const rate = rateMap[elCurrency.value] || 0;
  const rm = parseNum(elPrice.value) * rate;
  elPriceRM.value = formatCurrency(rm);
  updateSalesPrices(rm);
}

function updateSalesPrices(rm) {
  const prices = {
    '20%': rm * 1.26 * 1.12,
    '30%': rm * 1.43 * 1.12,
    '40%': rm * 1.67 * 1.12,
    '45%': rm * 1.82 * 1.12,
    '50%': rm * 2.00 * 1.12,
    '55%': rm * 2.23 * 1.12,
  };
  elPriceSummary.innerHTML = Object.entries(prices).map(([k, v]) =>
    `<div class="entry"${k==='50%' ? ' style="color:red;font-weight:bold;"' : ''}><strong>${k} 利润售价：</strong>RM ${formatCurrency(v)}</div>`
  ).join('');
}

// ✅ 自动计算金额 + 汇总
function updateFreightRatio() {
  const freight = parseNum(elFreightFee.value);
  const total = parseNum(elTotalAmount.value);
  elFreightRatio.value = formatPercent(total ? freight / total : 0);
}

// ✅ Enter 跳格 + 格式化
const fields = Array.from(elForm.querySelectorAll('input, select'));
fields.forEach((el, i) => {
  el.addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      e.preventDefault();
      if (["price", "freight_fee"].includes(el.id)) {
        el.value = formatCurrency(el.value);
        if (el.id === 'price') updateRM();
        if (el.id === 'freight_fee') updateFreightRatio();
      }
      let next = i + 1;
      while (fields[next] && (fields[next].disabled || fields[next].type === 'hidden')) next++;
      if (fields[next]) fields[next].focus();
    }
  });
  if (["price", "freight_fee"].includes(el.id)) {
    el.addEventListener('blur', () => {
      el.value = formatCurrency(el.value);
      if (el.id === 'price') updateRM();
      if (el.id === 'freight_fee') updateFreightRatio();
    });
  }
});

// ✅ 自动更新 RM
elCurrency.addEventListener('change', updateRM);
elPrice.addEventListener('input', updateRM);
</script>
</body>
</html>
