<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>盆栽成本记录系统 Lover Legend Gardening</title>
<style>
  body {
    font-family: sans-serif;
    background-color: #f5f5f5;
    margin: 0;
    padding: 20px;
  }
  .header {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    margin-bottom: 10px;
  }
  .header img { height: 50px; }
  .header h1 {
    font-size: 24px;
    margin: 0;
  }
  h2 {
    font-size: 18px;
    text-align: center;
    margin: 5px 0 15px;
    grid-column: 1 / -1;
  }
  form {
    background: #fff;
    padding: 20px;
    border-radius: 12px;
    max-width: 1000px;
    margin: auto;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px 20px;
  }
  label {
    font-weight: bold;
    font-size: 14px;
  }
  input, select, textarea {
    width: 100%;
    padding: 6px 8px;
    font-size: 14px;
    box-sizing: border-box;
    white-space: pre-wrap;
    overflow: hidden;
  }
  input::placeholder { color:#999; }
  .currency-placeholder { color:#999; }
  input[type=number]::-webkit-inner-spin-button,
  input[type=number]::-webkit-outer-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }
  .full { grid-column: 1 / -1; }
  .highlight { color: red; font-weight: bold; }
  .error {
    border: 2px solid red !important;
    background-color: #ffe6e6 !important;
  }
  .url-link {
    color: blue;
    text-decoration: underline;
    cursor: pointer;
  }
  .row3 { display: flex; gap: 6px; }
  .row3 > * { flex: 1; }
  .entry {
    font-size: 16px;
    margin-top: 4px;
  }
  .top-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    grid-column: 1 / -1;
  }
  .top-bar button {
    font-size: 14px;
    padding: 4px 10px;
    cursor: pointer;
  }
  #autoSaveStatus {
    font-size:12px;
    color:#666;
    margin-left:8px;
  }
  .with-datalist::-webkit-calendar-picker-indicator {
    display: none !important;
  }
  .date-error {
    color: red;
    font-size: 12px;
    margin-top: -10px;
    margin-bottom: 5px;
    grid-column: 1 / -1;
    display: none;
  }
  .shipping-section {
    background-color: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    margin-top: 15px;
    border: 1px solid #dee2e6;
    grid-column: 1 / -1;
  }
  .shipping-field:disabled {
    background-color: #e9ecef;
    opacity: 1;
  }
  .required-field {
    border-left: 3px solid #dc3545;
    padding-left: 5px;
  }
  .status-badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: bold;
  }
  .status-purchasing {
    background-color: #6c757d;
    color: white;
  }
  .status-shipping {
    background-color: #ffc107;
    color: #212529;
  }
  .status-completed {
    background-color: #198754;
    color: white;
  }
  #prepareShipping {
    background-color: #0d6efd;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    grid-column: 1 / -1;
    margin-top: 10px;
  }
  #prepareShipping:hover {
    background-color: #0b5ed7;
  }
</style>
</head>
<body>
  <div class="header">
    <img src="logo.png" alt="logo">
    <h1>盆栽成本记录系统 Lover Legend Gardening</h1>
  </div>

  <form id="bonsaiForm" autocomplete="off">
    <!-- 状态显示 -->
    <div class="top-bar">
      <div>
        <span id="form-status" class="status-badge status-purchasing">采购中</span>
        <span id="autoSaveStatus"></span>
      </div>
      <button type="button" onclick="manualSave()">💾 保存记录</button>
    </div>

    <!-- 🌱 采购信息部分 -->
    <h2 class="full">🌱 采购信息</h2>

    <label for="supplier" class="required-field">供应商</label>
    <label for="variety" class="required-field">品种</label>
    <input id="supplier" list="supplierHistory" class="with-datalist" required />
    <input id="variety" list="varietyHistory" class="with-datalist" required />
    <datalist id="supplierHistory"></datalist>
    <datalist id="varietyHistory"></datalist>

    <label>币值 + 单价（原币）+ RM 本钱</label>
    <label for="quantity" class="required-field">数量（棵）</label>
    <div class="row3">
      <select id="currency">
        <option value="CNY">CNY</option>
        <option value="VND">VND</option>
        <option value="NTD">NTD</option>
        <option value="IDR">IDR</option>
      </select>
      <input id="price" type="text" inputmode="decimal" placeholder="0.00" class="required-field" />
      <input id="price_rm" disabled placeholder="0.00" />
    </div>
    <input id="quantity" type="number" inputmode="numeric" pattern="[0-9]*" placeholder="0" required />

    <label for="image_url">图片网址</label>
    <div class="full"></div>
    <input id="image_url" type="url" class="url-link" placeholder="https://..." onclick="openImageUrl(this)" />

    <!-- 🚛 发货信息部分 -->
    <div class="shipping-section">
      <h2>🚛 发货信息</h2>

      <label for="shipment_id">发货单号</label>
      <label for="total_plants">发货总数</label>
      <input id="shipment_id" class="shipping-field" disabled placeholder="例如 2025CNY01" />
      <input id="total_plants" type="number" inputmode="numeric" pattern="[0-9]*" placeholder="0" class="shipping-field" disabled />

      <label for="total_amount">发货总金额（RM自动）</label>
      <label for="packing">包装明细（木架，箱子）</label>
      <input id="total_amount" disabled placeholder="0.00" class="shipping-field" />
      <input id="packing" placeholder="例如：1木架2箱子" class="shipping-field" disabled />

      <label for="warehouse_date">抵达仓库日期</label>
      <label for="container_date">装柜日期</label>
      <input id="warehouse_date" class="shipping-field date-input" placeholder="DD/MM/YY" disabled />
      <div id="warehouse_date_error" class="date-error">请输入有效的日期格式 (DD/MM/YY)</div>
      <input id="container_date" class="shipping-field date-input" placeholder="DD/MM/YY" disabled />
      <div id="container_date_error" class="date-error">请输入有效的日期格式 (DD/MM/YY)</div>

      <label for="shipping_no">海运单号</label>
      <label for="arrival_date">抵达日期</label>
      <input id="shipping_no" class="shipping-field" disabled />
      <input id="arrival_date" class="shipping-field date-input" placeholder="DD/MM/YY" disabled />
      <div id="arrival_date_error" class="date-error">请输入有效的日期格式 (DD/MM/YY)</div>

      <label for="freight_fee">运费（RM）</label>
      <label for="days">运输天数</label>
      <input id="freight_fee" type="text" inputmode="decimal" placeholder="0.00" class="shipping-field" disabled />
      <input id="days" disabled placeholder="0" />

      <label for="freight_ratio">运费比例（自动）</label>
      <div class="full"></div>
      <input id="freight_ratio" disabled placeholder="0%" />
    </div>

    <!-- 🧾 成本与销售细节 -->
    <h2 class="full">🧾 成本与销售细节</h2>

    <label for="local">本地运输</label>
    <label for="moss">苔藓</label>
    <input id="local" type="text" inputmode="decimal" placeholder="0.00" />
    <input id="moss" type="text" inputmode="decimal" placeholder="0.00" />

    <label for="pot">花盆</label>
    <label for="base_cost">原成本</label>
    <input id="pot" type="text" inputmode="decimal" placeholder="0.00" />
    <input id="base_cost" disabled placeholder="0.00" />

    <div id="priceSummary" class="full"></div>
    
    <!-- 发货准备按钮 -->
    <button type="button" id="prepareShipping" onclick="enableShippingFields()">
      ✈️ 准备发货信息
    </button>
  </form>

<script>
/* ------------------------ 基本设定 ------------------------ */
const firebaseConfig = {
  apiKey: "AIzaSyCKQFkAz5jcTvCAMUpWSJ1nuEP8mEE-l18",
  authDomain: "bonsai-live-system.firebaseapp.com",
  projectId: "bonsai-live-system",
  storageBucket: "bonsai-live-system.appspot.com",
  messagingSenderId: "804874268810",
  appId: "1:804874268810:web:9d1ede421c16643d01fd73"
};

const rateMap = { CNY: 1 / 1.55, NTD: 0.15, VND: 0.00018, IDR: 0.00028 };
let isShippingReady = false;
let formDirty = false;
let lastAutoSaveTS = 0;

/* ------------------------ Firebase 初始化 ------------------------ */
let app, db;
(async function initFirebase(){
  try {
    await loadScript("https://www.gstatic.com/firebasejs/11.0.0/firebase-app-compat.js");
    await loadScript("https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore-compat.js");
    app = firebase.initializeApp(firebaseConfig);
    db  = firebase.firestore();
    console.log("🔥 Firebase 初始化完成");
  } catch(err){
    console.error("Firebase 初始化失败：", err);
    alert("Firebase 初始化失败，请检查网络或配置。");
  }
})();

/* ------------------------ 工具函数 ------------------------ */
function loadScript(src){
  return new Promise((resolve, reject)=>{
    const s=document.createElement('script');
    s.src=src; s.onload=resolve; s.onerror=reject;
    document.head.appendChild(s);
  });
}

function openImageUrl(el){
  if(el.value && el.value.startsWith('http')) window.open(el.value, '_blank');
}

function stripCommas(v){ return v ? v.toString().replace(/,/g,'').trim() : ''; }

function parseNum(v){
  const num=parseFloat(stripCommas(v));
  return isNaN(num)?0:num;
}

function formatCurrency(val){
  const num = parseFloat(stripCommas(val));
  if(isNaN(num)) return '';
  return num.toLocaleString('en-MY',{minimumFractionDigits:2,maximumFractionDigits:2});
}

function formatPercent(val){
  if(isNaN(val)) return '0%';
  return (val*100).toFixed(2)+'%';
}

function parseDDMMYY(str){
  if(!str) return null;
  const [d,m,y]=str.split('/').map(n=>parseInt(n,10));
  if(isNaN(d)||isNaN(m)||isNaN(y)) return null;
  const fullY = y < 100 ? 2000 + y : y;
  const dt=new Date(fullY, m-1, d);
  if(dt.getFullYear()!==fullY || dt.getMonth()!==m-1 || dt.getDate()!==d) return null;
  return dt;
}

/* ------------------------ 核心功能 ------------------------ */
function enableShippingFields() {
  if(!validatePurchaseFields()) {
    alert('请先完成所有必填采购信息');
    return;
  }

  document.querySelectorAll('.shipping-field').forEach(field => {
    field.disabled = false;
  });
  
  document.getElementById('total_plants').value = document.getElementById('quantity').value;
  updateTotalAmount();
  
  isShippingReady = true;
  document.getElementById('form-status').textContent = '待发货';
  document.getElementById('form-status').className = 'status-badge status-shipping';
  document.getElementById('prepareShipping').textContent = '✅ 发货信息已准备';
  document.getElementById('prepareShipping').style.backgroundColor = '#198754';
  
  document.getElementById('shipment_id').focus();
}

function validatePurchaseFields() {
  const requiredFields = ['supplier', 'variety', 'price', 'quantity'];
  let isValid = true;
  
  requiredFields.forEach(id => {
    const field = document.getElementById(id);
    if(!field.value.trim()) {
      field.classList.add('error');
      isValid = false;
    } else {
      field.classList.remove('error');
    }
  });
  
  return isValid;
}

function validateDate(input, errorElement){
  const rawDigits = input.value.replace(/[^0-9]/g,'');
  
  if(rawDigits.length===6){
    input.value = rawDigits.replace(/(\d{2})(\d{2})(\d{2})/,'$1/$2/$3');
  } else if(rawDigits.length===8){
    input.value = rawDigits.replace(/(\d{2})(\d{2})(\d{4})/,'$1/$2/$3');
  }

  const dt=parseDDMMYY(input.value);
  if(!dt){
    input.classList.add('error');
    errorElement.style.display = 'block';
    input.setCustomValidity('请输入有效日期');
    return false;
  }else{
    input.classList.remove('error');
    errorElement.style.display = 'none';
    input.setCustomValidity('');
    if(input===document.getElementById('container_date') || input===document.getElementById('arrival_date')) {
      updateDays();
    }
    return true;
  }
}

function updateRM(){
  const cur=document.getElementById('currency').value;
  const raw=parseNum(document.getElementById('price').value);
  const rate=rateMap[cur]||0;
  const rm=raw*rate;
  document.getElementById('price_rm').value=isNaN(rm)?'':formatCurrency(rm);
  updateSalesPrices(rm);
  updateBaseCost();
  updateTotalAmount();
}

function updateSalesPrices(rmCostPerPlant){
  const prices={
    "20%": rmCostPerPlant * 1.26 * 1.12,
    "30%": rmCostPerPlant * 1.43 * 1.12,
    "40%": rmCostPerPlant * 1.67 * 1.12,
    "45%": rmCostPerPlant * 1.82 * 1.12,
    "50%": rmCostPerPlant * 2.00 * 1.12,
    "55%": rmCostPerPlant * 2.23 * 1.12
  };
  let html = '';
  for(const [key, value] of Object.entries(prices)){
    const style = key === "50%" ? 'style="color:red;font-weight:bold;"' : '';
    html += `<div class="entry" ${style}><strong>${key} 利润售价：</strong>RM ${formatCurrency(value)}</div>`;
  }
  document.getElementById('priceSummary').innerHTML = html;
}

function updateTotalAmount(){
  const quantity = parseNum(document.getElementById('total_plants').value) || parseNum(document.getElementById('quantity').value);
  const rmPerPlant = parseNum(document.getElementById('price_rm').value);
  const total = quantity * rmPerPlant;
  document.getElementById('total_amount').value = total ? formatCurrency(total) : '';
  updateFreightRatio();
}

function updateDays(){
  const cdt=parseDDMMYY(document.getElementById('container_date').value);
  const adt=parseDDMMYY(document.getElementById('arrival_date').value);
  if(!cdt || !adt){
    document.getElementById('days').value='';
    return;
  }
  let days = (adt - cdt)/(1000*60*60*24);
  if(isNaN(days) || days<0) days=0;
  document.getElementById('days').value = Math.round(days);
}

function updateFreightRatio(){
  const freight = parseNum(document.getElementById('freight_fee').value) || 0;
  const total = parseNum(document.getElementById('total_amount').value);
  const ratio = total>0 ? (freight/total) : 0;
  document.getElementById('freight_ratio').value = formatPercent(ratio);
}

function updateBaseCost(){
  const rmPerPlant = parseNum(document.getElementById('price_rm').value);
  const qty = parseNum(document.getElementById('quantity').value);
  const local = parseNum(document.getElementById('local').value);
  const moss = parseNum(document.getElementById('moss').value);
  const pot = parseNum(document.getElementById('pot').value);
  const base = (rmPerPlant*qty) + local + moss + pot;
  document.getElementById('base_cost').value = base ? formatCurrency(base) : '';
}

/* ------------------------ 事件监听 ------------------------ */
document.getElementById('currency').addEventListener('change', updateRM);
document.getElementById('price').addEventListener('input', updateRM);
document.getElementById('price').addEventListener('blur', function(){
  this.value=formatCurrency(this.value); 
  updateRM();
});
document.getElementById('quantity').addEventListener('input', updateBaseCost);
document.getElementById('total_plants').addEventListener('input', updateTotalAmount);
document.getElementById('freight_fee').addEventListener('input', updateFreightRatio);
document.getElementById('freight_fee').addEventListener('blur', function(){
  this.value=formatCurrency(this.value); 
  updateFreightRatio();
});

['local','moss','pot'].forEach(id=>{
  document.getElementById(id).addEventListener('input', updateBaseCost);
  document.getElementById(id).addEventListener('blur', function(){
    this.value=formatCurrency(this.value);
    updateBaseCost();
  });
});

document.getElementById('warehouse_date').addEventListener('blur', function(){
  validateDate(this, document.getElementById('warehouse_date_error'));
});
document.getElementById('container_date').addEventListener('blur', function(){
  validateDate(this, document.getElementById('container_date_error'));
});
document.getElementById('arrival_date').addEventListener('blur', function(){
  validateDate(this, document.getElementById('arrival_date_error'));
});

/* ------------------------ 保存功能 ------------------------ */
function showAutoSaveStatus(txt,isError=false){
  const el = document.getElementById('autoSaveStatus');
  el.textContent=txt;
  el.style.color=isError?'red':'#666';
}

async function manualSave(){
  const ok = validateBeforeSave();
  if(!ok) return;
  
  try {
    await saveRecordToFirebase();
    alert("✅ 资料已储存！");
  } catch(err) {
    console.error(err);
    alert("❌ 储存失败，请检查网络或配置。");
  }
}

function validateBeforeSave(){
  if(!validatePurchaseFields()) return false;
  
  if(isShippingReady) {
    const requiredShippingFields = ['shipment_id', 'warehouse_date'];
    let isValid = true;
    
    requiredShippingFields.forEach(id => {
      const field = document.getElementById(id);
      if(!field.value.trim()) {
        field.classList.add('error');
        isValid = false;
      } else {
        field.classList.remove('error');
      }
    });
    
    if(!isValid) {
      alert('请填写完整的发货信息');
      return false;
    }
    
    // 验证日期
    const datesValid = [
      validateDate(document.getElementById('warehouse_date'), document.getElementById('warehouse_date_error')),
      validateDate(document.getElementById('container_date'), document.getElementById('container_date_error')),
      validateDate(document.getElementById('arrival_date'), document.getElementById('arrival_date_error'))
    ].every(valid => valid);
    
    if(!datesValid) return false;
  }
  
  return true;
}

async function saveRecordToFirebase(){
  if(!db) throw new Error('Firebase Firestore 未初始化');
  
  const docData = {
    // 采购信息
    supplier: document.getElementById('supplier').value.trim(),
    variety: document.getElementById('variety').value.trim(),
    currency: document.getElementById('currency').value,
    unit_price_foreign: parseNum(document.getElementById('price').value),
    unit_price_rm: parseNum(document.getElementById('price_rm').value),
    quantity: parseNum(document.getElementById('quantity').value),
    image_url: document.getElementById('image_url').value.trim(),
    
    // 状态信息
    status: isShippingReady ? '待发货' : '采购中',
    created_at: new Date().toISOString()
  };
  
  // 发货信息（如果有）
  if(isShippingReady) {
    docData.shipment_id = document.getElementById('shipment_id').value.trim();
    docData.total_plants = parseNum(document.getElementById('total_plants').value);
    docData.total_amount_rm = parseNum(document.getElementById('price_rm').value) * docData.total_plants;
    docData.packing = document.getElementById('packing').value.trim();
    docData.warehouse_date = document.getElementById('warehouse_date').value.trim();
    docData.container_date = document.getElementById('container_date').value.trim();
    docData.shipping_no = document.getElementById('shipping_no').value.trim();
    docData.arrival_date = document.getElementById('arrival_date').value.trim();
    docData.transit_days = parseNum(document.getElementById('days').value);
    docData.freight_rm = parseNum(document.getElementById('freight_fee').value) || 0;
    docData.freight_ratio = document.getElementById('freight_ratio').value.trim();
    
    // 更新状态为已完成
    docData.status = '已完成';
    document.getElementById('form-status').textContent = '已完成';
    document.getElementById('form-status').className = 'status-badge status-completed';
  }
  
  // 成本信息
  docData.local_transport = parseNum(document.getElementById('local').value);
  docData.moss = parseNum(document.getElementById('moss').value);
  docData.pot = parseNum(document.getElementById('pot').value);
  docData.base_cost = parseNum(document.getElementById('base_cost').value);

  // 保存到Firestore
  await db.collection('bonsai_records').add(docData);

  // 更新历史记录
  addToHistory('supplier', document.getElementById('supplier').value);
  addToHistory('variety', document.getElementById('variety').value);

  formDirty = false;
  lastAutoSaveTS = Date.now();
  showAutoSaveStatus('已储存 ' + new Date().toLocaleTimeString());
  
  // 如果是发货记录，更新汇总
  if(isShippingReady) {
    aggregateShipments();
  }
}

/* ------------------------ 自动保存 ------------------------ */
const AUTO_SAVE_INTERVAL = 3 * 60 * 1000;
setInterval(async()=>{
  if(!formDirty) return;
  const ok=validateBeforeSave();
  if(!ok){ 
    showAutoSaveStatus('自动储存失败：表单未通过验证',true); 
    return; 
  }
  try{
    await saveRecordToFirebase();
    showAutoSaveStatus('自动储存完成 '+new Date().toLocaleTimeString());
  }catch(err){
    console.error('自动储存失败',err);
    showAutoSaveStatus('自动储存失败',true);
  }
}, AUTO_SAVE_INTERVAL);

/* ------------------------ 历史记录 ------------------------ */
const SUPPLIER_STORE_KEY = 'bonsai_supplier_history_v1';
const VARIETY_STORE_KEY = 'bonsai_variety_history_v1';

function addToHistory(id,key){
  const raw=key.trim();
  if(!raw) return;
  const storeKey = id==='supplier'?SUPPLIER_STORE_KEY:VARIETY_STORE_KEY;
  const arr=JSON.parse(localStorage.getItem(storeKey)||'[]');
  if(!arr.includes(raw)){
    arr.push(raw);
    arr.sort();
    localStorage.setItem(storeKey,JSON.stringify(arr));
    loadHistoryOptions();
  }
}

function loadHistoryOptions(){
  const supers = JSON.parse(localStorage.getItem(SUPPLIER_STORE_KEY)||'[]');
  const vars = JSON.parse(localStorage.getItem(VARIETY_STORE_KEY)||'[]');
  fillDatalist('supplierHistory',supers);
  fillDatalist('varietyHistory',vars);
}

function fillDatalist(id,arr){
  const dl=document.getElementById(id);
  dl.innerHTML='';
  arr.forEach(v=>{
    const opt=document.createElement('option');
    opt.value=v;
    dl.appendChild(opt);
  });
}

/* ------------------------ 发货汇总 ------------------------ */
async function aggregateShipments(){
  if(!db) return;
  try{
    const snap=await db.collection('bonsai_records').orderBy('created_at','desc').limit(500).get();
    const groups={};
    snap.forEach(doc=>{
      const d=doc.data();
      const sid=d.shipment_id||'';
      if(!groups[sid]) groups[sid]={plants:0,amount:0,rows:0};
      const p = d.total_plants>0?d.total_plants:d.quantity;
      const amt = d.total_amount_rm>0?d.total_amount_rm:(d.unit_price_rm * p);
      groups[sid].plants += p;
      groups[sid].amount += amt;
      groups[sid].rows++;
    });
    console.log('📦 发货单号汇总：',groups);
  }catch(err){
    console.error('汇总失败',err);
  }
}

/* ------------------------ 初始化 ------------------------ */
function init(){
  loadHistoryOptions();
  updateRM();
  updateBaseCost();
  updateTotalAmount();
  updateFreightRatio();
  updateDays();
  
  // 表单输入监听
  document.getElementById('bonsaiForm').addEventListener('input', ()=>{ 
    formDirty=true; 
  });
  
  // Enter跳格
  const formFields = Array.from(document.querySelectorAll('#bonsaiForm input, #bonsaiForm select, #bonsaiForm textarea, #bonsaiForm button:not([type=button])'));
  formFields.forEach((el,i)=>{
    el.addEventListener('keydown', e=>{
      if(e.key==='Enter'){
        if(el.tagName==='BUTTON') return;
        e.preventDefault();
        
        if(el.classList.contains('date-input')){
          let errorElement;
          if(el === document.getElementById('warehouse_date')) errorElement = document.getElementById('warehouse_date_error');
          else if(el === document.getElementById('container_date')) errorElement = document.getElementById('container_date_error');
          else if(el === document.getElementById('arrival_date')) errorElement = document.getElementById('arrival_date_error');
          
          const ok=validateDate(el, errorElement);
          if(!ok) return;
        }
        
        const id=el.id;
        if(['price','freight_fee','local','moss','pot'].includes(id)){
          el.value=formatCurrency(el.value);
        }
        
        let next=i+1;
        while(next<formFields.length && (formFields[next].disabled || formFields[next].type==='hidden')) next++;
        if(formFields[next]) formFields[next].focus();
      }
    });
  });
  
  // 初始聚焦
  document.getElementById('supplier').focus();
}

window.addEventListener('load', init);
</script>
</body>
</html>
