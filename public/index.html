<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>盆栽成本记录系统 Lover Legend Gardening</title>
<style>
  body {
    font-family: sans-serif;
    background-color: #f5f5f5;
    margin: 0;
    padding: 20px;
  }
  .header {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    margin-bottom: 10px;
  }
  .header img { height: 50px; }
  .header h1 {
    font-size: 24px;
    margin: 0;
  }
  h2 {
    font-size: 18px;
    text-align: center;
    margin: 5px 0 15px;
    grid-column: 1 / -1;
  }
  form {
    background: #fff;
    padding: 20px;
    border-radius: 12px;
    max-width: 1000px;
    margin: auto;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px 20px;
  }
  label {
    font-weight: bold;
    font-size: 14px;
  }
  input, select, textarea {
    width: 100%;
    padding: 6px 8px;
    font-size: 14px;
    box-sizing: border-box;
    white-space: pre-wrap;
    overflow: hidden;
  }
  input::placeholder { color:#999; }
  .currency-placeholder { color:#999; }
  input[type=number]::-webkit-inner-spin-button,
  input[type=number]::-webkit-outer-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }
  .full { grid-column: 1 / -1; }
  .highlight { color: red; font-weight: bold; }
  .error {
    border: 2px solid red !important;
    background-color: #ffe6e6 !important;
  }
  .url-link {
    color: blue;
    text-decoration: underline;
    cursor: pointer;
  }
  .row3 { display: flex; gap: 6px; }
  .row3 > * { flex: 1; }
  .entry {
    font-size: 16px;
    margin-top: 4px;
  }
  .top-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    grid-column: 1 / -1;
  }
  .top-bar button {
    font-size: 14px;
    padding: 4px 10px;
    cursor: pointer;
  }
  #autoSaveStatus {
    font-size:12px;
    color:#666;
    margin-left:8px;
  }
  .with-datalist::-webkit-calendar-picker-indicator {
    display: none !important;
  }
  .date-error {
    color: red;
    font-size: 12px;
    margin-top: -10px;
    margin-bottom: 5px;
    grid-column: 1 / -1;
    display: none;
  }
  .shipping-section {
    background-color: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    margin-top: 15px;
    border: 1px solid #dee2e6;
    grid-column: 1 / -1;
  }
  .shipping-field:disabled {
    background-color: #e9ecef;
    opacity: 1;
  }
  .required-field {
    border-left: 3px solid #dc3545;
    padding-left: 5px;
  }
  .status-badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: bold;
  }
  .status-purchasing {
    background-color: #6c757d;
    color: white;
  }
  .status-shipping {
    background-color: #ffc107;
    color: #212529;
  }
  .status-completed {
    background-color: #198754;
    color: white;
  }
  #prepareShipping {
    background-color: #0d6efd;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    grid-column: 1 / -1;
    margin-top: 10px;
  }
  #prepareShipping:hover {
    background-color: #0b5ed7;
  }
  /* 新增错误提示样式 */
  .firebase-error {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px;
    background: #ff4444;
    color: white;
    border-radius: 5px;
    z-index: 10000;
    max-width: 300px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    animation: slideIn 0.3s ease-out;
  }
  @keyframes slideIn {
    from { transform: translateX(100%); }
    to { transform: translateX(0); }
  }
</style>
</head>
<body>
  <div class="header">
    <img src="logo.png" alt="logo">
    <h1>盆栽成本记录系统 Lover Legend Gardening</h1>
  </div>

  <form id="bonsaiForm" autocomplete="off">
    <!-- 状态显示 -->
    <div class="top-bar">
      <div>
        <span id="form-status" class="status-badge status-purchasing">采购中</span>
        <span id="autoSaveStatus"></span>
      </div>
      <button type="button" onclick="manualSave()">💾 保存记录</button>
    </div>

    <!-- 🌱 采购信息部分 -->
    <h2 class="full">🌱 采购信息</h2>

    <label for="supplier" class="required-field">供应商</label>
    <label for="variety" class="required-field">品种</label>
    <input id="supplier" list="supplierHistory" class="with-datalist" required />
    <input id="variety" list="varietyHistory" class="with-datalist" required />
    <datalist id="supplierHistory"></datalist>
    <datalist id="varietyHistory"></datalist>

    <label>币值 + 单价（原币）+ RM 本钱</label>
    <label for="quantity" class="required-field">数量（棵）</label>
    <div class="row3">
      <select id="currency">
        <option value="CNY">CNY</option>
        <option value="VND">VND</option>
        <option value="NTD">NTD</option>
        <option value="IDR">IDR</option>
      </select>
      <input id="price" type="text" inputmode="decimal" placeholder="0.00" class="required-field" />
      <input id="price_rm" disabled placeholder="0.00" />
    </div>
    <input id="quantity" type="number" inputmode="numeric" pattern="[0-9]*" placeholder="0" required />

    <label for="image_url">图片网址</label>
    <div class="full"></div>
    <input id="image_url" type="url" class="url-link" placeholder="https://..." onclick="openImageUrl(this)" />

    <!-- 🚛 发货信息部分 -->
    <div class="shipping-section">
      <h2>🚛 发货信息</h2>

      <label for="shipment_id">发货单号</label>
      <label for="total_plants">发货总数</label>
      <input id="shipment_id" class="shipping-field" disabled placeholder="例如 2025CNY01" />
      <input id="total_plants" type="number" inputmode="numeric" pattern="[0-9]*" placeholder="0" class="shipping-field" disabled />

      <label for="total_amount">发货总金额（RM自动）</label>
      <label for="packing">包装明细（木架，箱子）</label>
      <input id="total_amount" disabled placeholder="0.00" class="shipping-field" />
      <input id="packing" placeholder="例如：1木架2箱子" class="shipping-field" disabled />

      <label for="warehouse_date">抵达仓库日期</label>
      <label for="container_date">装柜日期</label>
      <input id="warehouse_date" class="shipping-field date-input" placeholder="DD/MM/YY" disabled />
      <div id="warehouse_date_error" class="date-error">请输入有效的日期格式 (DD/MM/YY)</div>
      <input id="container_date" class="shipping-field date-input" placeholder="DD/MM/YY" disabled />
      <div id="container_date_error" class="date-error">请输入有效的日期格式 (DD/MM/YY)</div>

      <label for="shipping_no">海运单号</label>
      <label for="arrival_date">抵达日期</label>
      <input id="shipping_no" class="shipping-field" disabled />
      <input id="arrival_date" class="shipping-field date-input" placeholder="DD/MM/YY" disabled />
      <div id="arrival_date_error" class="date-error">请输入有效的日期格式 (DD/MM/YY)</div>

      <label for="freight_fee">运费（RM）</label>
      <label for="days">运输天数</label>
      <input id="freight_fee" type="text" inputmode="decimal" placeholder="0.00" class="shipping-field" disabled />
      <input id="days" disabled placeholder="0" />

      <label for="freight_ratio">运费比例（自动）</label>
      <div class="full"></div>
      <input id="freight_ratio" disabled placeholder="0%" />
    </div>

    <!-- 🧾 成本与销售细节 -->
    <h2 class="full">🧾 成本与销售细节</h2>

    <label for="local">本地运输</label>
    <label for="moss">苔藓</label>
    <input id="local" type="text" inputmode="decimal" placeholder="0.00" />
    <input id="moss" type="text" inputmode="decimal" placeholder="0.00" />

    <label for="pot">花盆</label>
    <label for="base_cost">原成本</label>
    <input id="pot" type="text" inputmode="decimal" placeholder="0.00" />
    <input id="base_cost" disabled placeholder="0.00" />

    <div id="priceSummary" class="full"></div>
    
    <!-- 发货准备按钮 -->
    <button type="button" id="prepareShipping" onclick="enableShippingFields()">
      ✈️ 准备发货信息
    </button>
  </form>

<script>
/* ======================== 全局配置 ======================== */
const firebaseConfig = {
  apiKey: "11.8b2c9E9A5e5jc7ec8eUgN5aTnafF8efE-11F",
  authDomain: "bureau-line-system.firebaseapp.com",
  projectId: "bureau-line-system",
  storageBucket: "bureau-line-system.appspot.com",
  messagingSenderId: "88a487c2888",
  appId: "1:8880487c2888:web:19freeNetTo164d8011673"
};

const rateMap = { CNY: 1 / 1.55, NTD: 0.15, VND: 0.00018, IDR: 0.00028 };
let app, db; // Firebase实例
let isShippingReady = false;
let formDirty = false;
let lastAutoSaveTS = 0;

/* ======================== Firebase初始化 ======================== */
async function initFirebase() {
  try {
    // 动态加载Firebase SDK
    await Promise.all([
      loadScript("https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"),
      loadScript("https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js")
    ]);
    
    // 初始化Firebase
    app = firebase.initializeApp(firebaseConfig);
    db = firebase.firestore();
    
    // 测试连接
    await db.collection("connection_test").doc("init").set({
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    console.log("🔥 Firebase 初始化成功");
    
    // 启用离线持久化（可选）
    try {
      await db.enablePersistence();
      console.log("离线持久化已启用");
    } catch (err) {
      console.warn("离线持久化不可用:", err);
    }
  } catch (err) {
    console.error("Firebase 初始化失败:", err);
    showError("Firebase初始化失败: " + err.message);
  }
}

/* ======================== 数据操作 ======================== */
async function saveRecordToFirebase() {
  if (!db) throw new Error("Firestore 未初始化");

  // 准备数据
  const docData = {
    // 采购信息
    supplier: document.getElementById("supplier").value.trim(),
    variety: document.getElementById("variety").value.trim(),
    currency: document.getElementById("currency").value,
    unit_price_foreign: parseNum(document.getElementById("price").value),
    unit_price_rm: parseNum(document.getElementById("price_rm").value),
    quantity: parseInt(document.getElementById("quantity").value),
    image_url: document.getElementById("image_url").value.trim(),
    
    // 状态信息
    status: isShippingReady ? "待发货" : "采购中",
    created_at: firebase.firestore.FieldValue.serverTimestamp(),
    updated_at: firebase.firestore.FieldValue.serverTimestamp()
  };

  // 发货信息
  if (isShippingReady) {
    Object.assign(docData, {
      shipment_id: document.getElementById("shipment_id").value.trim(),
      total_plants: parseInt(document.getElementById("total_plants").value),
      total_amount_rm: parseNum(document.getElementById("total_amount").value),
      packing: document.getElementById("packing").value.trim(),
      warehouse_date: document.getElementById("warehouse_date").value.trim(),
      container_date: document.getElementById("container_date").value.trim(),
      shipping_no: document.getElementById("shipping_no").value.trim(),
      arrival_date: document.getElementById("arrival_date").value.trim(),
      transit_days: parseInt(document.getElementById("days").value),
      freight_fee: parseNum(document.getElementById("freight_fee").value),
      freight_ratio: document.getElementById("freight_ratio").value,
      status: "已完成"
    });
  }

  // 成本信息
  Object.assign(docData, {
    local_transport: parseNum(document.getElementById("local").value),
    moss: parseNum(document.getElementById("moss").value),
    pot: parseNum(document.getElementById("pot").value),
    base_cost: parseNum(document.getElementById("base_cost").value)
  });

  try {
    console.log("正在写入数据:", docData);
    const docRef = await db.collection("bonsai_records").add(docData);
    console.log("文档写入成功，ID:", docRef.id);
    
    // 验证写入
    const savedDoc = await docRef.get();
    if (!savedDoc.exists) throw new Error("文档写入后验证失败");
    
    // 更新历史记录
    addToHistory("supplier", docData.supplier);
    addToHistory("variety", docData.variety);
    
    return true;
  } catch (err) {
    console.error("写入过程中出错:", err);
    throw err;
  }
}

/* ======================== 表单功能 ======================== */
function enableShippingFields() {
  if (!validatePurchaseFields()) {
    showError("请先完成所有必填采购信息");
    return;
  }

  document.querySelectorAll(".shipping-field").forEach(field => {
    field.disabled = false;
  });
  
  document.getElementById("total_plants").value = document.getElementById("quantity").value;
  updateTotalAmount();
  
  isShippingReady = true;
  document.getElementById("form-status").textContent = "待发货";
  document.getElementById("form-status").className = "status-badge status-shipping";
  document.getElementById("prepareShipping").textContent = "✅ 发货信息已准备";
  document.getElementById("prepareShipping").style.backgroundColor = "#198754";
  
  document.getElementById("shipment_id").focus();
}

function validatePurchaseFields() {
  const requiredFields = ["supplier", "variety", "price", "quantity"];
  let isValid = true;
  
  requiredFields.forEach(id => {
    const field = document.getElementById(id);
    if (!field.value.trim()) {
      field.classList.add("error");
      isValid = false;
    } else {
      field.classList.remove("error");
    }
  });
  
  return isValid;
}

function validateBeforeSave() {
  if (!validatePurchaseFields()) return false;
  
  if (isShippingReady) {
    const requiredShippingFields = ["shipment_id", "warehouse_date"];
    let isValid = true;
    
    requiredShippingFields.forEach(id => {
      const field = document.getElementById(id);
      if (!field.value.trim()) {
        field.classList.add("error");
        isValid = false;
      } else {
        field.classList.remove("error");
      }
    });
    
    if (!isValid) {
      showError("请填写完整的发货信息");
      return false;
    }
    
    // 验证日期
    const datesValid = [
      validateDate(document.getElementById("warehouse_date"), document.getElementById("warehouse_date_error")),
      validateDate(document.getElementById("container_date"), document.getElementById("container_date_error")),
      validateDate(document.getElementById("arrival_date"), document.getElementById("arrival_date_error"))
    ].every(valid => valid);
    
    if (!datesValid) return false;
  }
  
  return true;
}

/* ======================== 工具函数 ======================== */
function loadScript(src) {
  return new Promise((resolve, reject) => {
    const script = document.createElement("script");
    script.src = src;
    script.onload = resolve;
    script.onerror = () => reject(new Error(`脚本加载失败: ${src}`));
    document.head.appendChild(script);
  });
}

function showError(message) {
  // 移除现有错误提示
  const existingError = document.querySelector(".firebase-error");
  if (existingError) existingError.remove();
  
  const errorDiv = document.createElement("div");
  errorDiv.className = "firebase-error";
  errorDiv.textContent = message;
  document.body.appendChild(errorDiv);
  
  setTimeout(() => {
    errorDiv.remove();
  }, 5000);
}

function showAutoSaveStatus(txt, isError = false) {
  const el = document.getElementById("autoSaveStatus");
  el.textContent = txt;
  el.style.color = isError ? "red" : "#666";
}

function parseNum(str) {
  if (!str) return 0;
  const num = parseFloat(str.toString().replace(/,/g, ""));
  return isNaN(num) ? 0 : num;
}

function formatCurrency(val) {
  const num = parseFloat(stripCommas(val));
  if (isNaN(num)) return "";
  return num.toLocaleString("en-MY", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function stripCommas(v) {
  return v ? v.toString().replace(/,/g, "").trim() : "";
}

function validateDate(input, errorElement) {
  const rawDigits = input.value.replace(/[^0-9]/g, "");
  
  if (rawDigits.length === 6) {
    input.value = rawDigits.replace(/(\d{2})(\d{2})(\d{2})/, "$1/$2/$3");
  } else if (rawDigits.length === 8) {
    input.value = rawDigits.replace(/(\d{2})(\d{2})(\d{4})/, "$1/$2/$3");
  }

  const dt = parseDDMMYY(input.value);
  if (!dt) {
    input.classList.add("error");
    errorElement.style.display = "block";
    input.setCustomValidity("请输入有效日期");
    return false;
  } else {
    input.classList.remove("error");
    errorElement.style.display = "none";
    input.setCustomValidity("");
    if (input === document.getElementById("container_date") || 
        input === document.getElementById("arrival_date")) {
      updateDays();
    }
    return true;
  }
}

function parseDDMMYY(str) {
  if (!str) return null;
  const [d, m, y] = str.split("/").map(n => parseInt(n, 10));
  if (isNaN(d) || isNaN(m) || isNaN(y)) return null;
  const fullY = y < 100 ? 2000 + y : y;
  const dt = new Date(fullY, m - 1, d);
  if (dt.getFullYear() !== fullY || dt.getMonth() !== m - 1 || dt.getDate() !== d) return null;
  return dt;
}

/* ======================== 初始化 ======================== */
window.addEventListener("load", async () => {
  await initFirebase();
  initForm();
});

function initForm() {
  // 初始化表单逻辑...
  console.log("表单初始化完成");
}
</script>
</body>
</html>
